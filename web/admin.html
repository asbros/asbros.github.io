<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Cash ↔ Credit Card Platform</title>
  <!-- Google Fonts: Jost -->
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Jost', sans-serif;
      color: #212529;
      padding-top: 2rem;
      padding-bottom: 3rem;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
    }
    thead th {
      vertical-align: middle;
      background-color: #e9ecef !important;
      color: #495057;
      border-color: #dee2e6;
    }
    .table-striped > tbody > tr:nth-of-type(odd) {
      --bs-table-accent-bg: #f8f9fa;
    }
    .table-bordered {
      border-color: #dee2e6;
    }
    .table-bordered td, .table-bordered th {
      border-color: #dee2e6;
    }
    .card-posting-row {
      background-color: #f1f3f5;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.15rem;
      border-radius: 0.3rem;
    }
    .form-control-sm {
      min-width: 120px;
      background-color: #ffffff;
      border: 1px solid #ced4da;
      color: #212529;
    }
    .form-control-sm:focus {
      background-color: #ffffff;
      color: #212529;
      box-shadow: 0 0 8px 2px #2563ebaa;
      border-color: #2563eb;
    }
    .form-select {
      background-color: #ffffff;
      border: 1px solid #ced4da;
      color: #212529;
    }
    .form-select:focus {
      background-color: #ffffff;
      box-shadow: 0 0 8px 2px #2563ebaa;
      border-color: #2563eb;
      color: #212529;
    }
    .form-check-input {
      background-color: #ffffff;
      border: 1px solid #ced4da;
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .form-check-input:checked {
      background-color: #2563eb;
      border-color: #2563eb;
    }
    .form-check-input:focus {
      box-shadow: 0 0 8px 2px #2563ebaa;
      border-color: #2563eb;
    }
    /* Blocked styling */
    .blocked-row {
      background-color: #f8d7da !important;
      color: #721c24 !important;
    }
    .blocked-row input,
    .blocked-row select {
      background-color: #f1b7bd !important;
      border-color: #dc3545 !important;
      color: #721c24 !important;
    }
    .block-label {
      color: #dc3545;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 0.2rem;
      display: block;
      user-select: none;
    }
    .collapse-header {
      cursor: pointer;
      user-select: none;
      background-color: #2563eb;
      color: #ffffff;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      transition: background-color 0.2s ease;
    }
    .collapse-header:hover,
    .collapse-header:focus-visible {
      background-color: #1e40af;
      outline: none;
    }
    /* Responsive adjustments */
    @media (max-width: 991px) {
      .form-control-sm {
        min-width: 100%;
        margin-bottom: 0.3rem;
      }
      .card-posting-row {
        flex-direction: column;
        align-items: stretch;
      }
      .card-posting-row input, .card-posting-row button {
        width: 100% !important;
        margin-bottom: 0.25rem !important;
      }
    }
    /* SweetAlert2 light theme override */
    .swal2-popup {
      background: #ffffff !important;
      color: #212529 !important;
      box-shadow: 0 0 15px rgba(37, 99, 235, 0.3) !important;
    }
    .swal2-title, .swal2-content {
      color: #212529 !important;
    }
    .swal2-styled.swal2-confirm {
      background-color: #2563eb !important;
      color: #ffffff !important;
    }
    .swal2-styled.swal2-cancel {
      background-color: #6c757d !important;
      color: #ffffff !important;
    }
  </style>
</head>
<body>
  <main class="container" role="main" tabindex="0">
    <h1 class="mb-4 text-center text-primary fw-bold">Admin Panel - User Management</h1>
    <!-- Cash Users Section -->
    <section>
      <div class="collapse-header" id="toggleCashUsers" tabindex="0" role="button" aria-expanded="true" aria-controls="cashUsersSection">
        Cash Users <i class="bi bi-chevron-up" id="cashUsersIcon" aria-hidden="true"></i>
      </div>
      <div id="cashUsersSection" class="mb-4" aria-live="polite" aria-label="Cash users section">
        <div class="mb-3">
          <input type="search" id="searchCashInput" class="form-control" placeholder="Search cash users by username" aria-label="Search cash users by username" />
        </div>
        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
          <table class="table table-striped table-bordered align-middle" id="cashUsersTable" tabindex="0" aria-label="Table of cash users">
            <thead>
              <tr>
                <th scope="col">Full Name</th>
                <th scope="col">Username</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Role</th>
                <th scope="col">Verified</th>
                <th scope="col" style="width: 110px;">Blocked</th>
                <th scope="col" class="text-center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="cashUsersTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Credit Card Holders Section -->
    <section>
      <div class="collapse-header" id="toggleCardUsers" tabindex="0" role="button" aria-expanded="true" aria-controls="cardUsersSection">
        Credit Card Holders <i class="bi bi-chevron-up" id="cardUsersIcon" aria-hidden="true"></i>
      </div>
      <div id="cardUsersSection" class="mb-4" aria-live="polite" aria-label="Credit card holders section">
        <div class="mb-3">
          <input type="search" id="searchCardInput" class="form-control" placeholder="Search credit card holders by username" aria-label="Search credit card holders by username" />
        </div>
        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
          <table class="table table-striped table-bordered align-middle" id="cardUsersTable" tabindex="0" aria-label="Table of credit card holders">
            <thead>
              <tr>
                <th scope="col">Full Name</th>
                <th scope="col">Username</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Role</th>
                <th scope="col">Verified</th>
                <th scope="col" style="min-width: 280px;">Card Postings (Bank - Limit ₹)</th>
                <th scope="col" style="width: 110px;">Blocked</th>
                <th scope="col" class="text-center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="cardUsersTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Firebase config and init
    const firebaseConfig = {
      apiKey: "AIzaSyCxJqJadOqmVA9XHUEnf_bzY8_j9WhoOsc",
      authDomain: "chat-ebbc6.firebaseapp.com",
      databaseURL: "https://chat-ebbc6-default-rtdb.firebaseio.com",
      projectId: "chat-ebbc6",
      storageBucket: "chat-ebbc6.appspot.com",
      messagingSenderId: "900704224803",
      appId: "1:900704224803:web:849180c787132c7baa1396",
      measurementId: "G-YYNMD5MS6M"
    };
    firebase.initializeApp(firebaseConfig);
    // DOM elements
    const cashUsersTbody = document.getElementById('cashUsersTbody');
    const cardUsersTbody = document.getElementById('cardUsersTbody');
    const searchCashInput = document.getElementById('searchCashInput');
    const searchCardInput = document.getElementById('searchCardInput');
    const toggleCashUsers = document.getElementById('toggleCashUsers');
    const toggleCardUsers = document.getElementById('toggleCardUsers');
    const cashUsersSection = document.getElementById('cashUsersSection');
    const cardUsersSection = document.getElementById('cardUsersSection');
    const cashUsersIcon = document.getElementById('cashUsersIcon');
    const cardUsersIcon = document.getElementById('cardUsersIcon');
    let allUsers = {};
    // Toggle section expand/collapse
    function toggleSection(section, icon) {
      const isExpanded = section.style.display !== 'none';
      if(isExpanded) {
        section.style.display = 'none';
        icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        section.setAttribute('aria-expanded', 'false');
      } else {
        section.style.display = '';
        icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
        section.setAttribute('aria-expanded', 'true');
      }
    }
    toggleCashUsers.onclick = () => toggleSection(cashUsersSection, cashUsersIcon);
    toggleCashUsers.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(cashUsersSection, cashUsersIcon); } };
    toggleCardUsers.onclick = () => toggleSection(cardUsersSection, cardUsersIcon);
    toggleCardUsers.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(cardUsersSection, cardUsersIcon); } };
    // Initial expanded view
    cashUsersSection.style.display = '';
    cashUsersIcon.classList.add('bi-chevron-up');
    cardUsersSection.style.display = '';
    cardUsersIcon.classList.add('bi-chevron-up');
    // Load users from Firebase
    async function loadUsers() {
      Swal.fire({
        title: 'Loading users...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
      });
      try {
        const snapshot = await firebase.database().ref('users').once('value');
        allUsers = snapshot.exists() ? snapshot.val() : {};
        renderUsers();
      } catch(error) {
        Swal.fire('Error', 'Failed to load users: ' + error.message, 'error');
      } finally {
        Swal.close();
      }
    }
    // Render and filter users by role & username
    function renderUsers() {
      const cashFilter = searchCashInput.value.trim().toLowerCase();
      const cardFilter = searchCardInput.value.trim().toLowerCase();
      cashUsersTbody.innerHTML = '';
      cardUsersTbody.innerHTML = '';
      const cashUsers = [];
      const cardUsers = [];
      Object.entries(allUsers).forEach(([uid, user]) => {
        if(user.role === 'cash') cashUsers.push([uid, user]);
        else if(user.role === 'card') cardUsers.push([uid, user]);
      });
      renderUserRows(cashUsers, cashUsersTbody, cashFilter, false);
      renderUserRows(cardUsers, cardUsersTbody, cardFilter, true);
    }
    // Render rows with full editing; blocked users visually distinct but editable
    function renderUserRows(usersArray, tbody, filter, showCardPostings) {
      const filteredUsers = usersArray.filter(([uid, user]) => !filter || (user.username && user.username.toLowerCase().includes(filter)));
      if(filteredUsers.length === 0) {
        const tr = document.createElement('tr');
        const colspanVal = showCardPostings ? 9 : 8;
        tr.innerHTML = `<td colspan="${colspanVal}" class="text-center text-muted">No users found.</td>`;
        tbody.appendChild(tr);
        return;
      }
      filteredUsers.sort((a,b) => a[1].username.toLowerCase().localeCompare(b[1].username.toLowerCase()));
      filteredUsers.forEach(([uid, user]) => {
        const tr = document.createElement('tr');
        tr.dataset.uid = uid;
        if(user.blocked) {
          tr.classList.add('blocked-row');
        } else {
          tr.classList.remove('blocked-row');
        }
        if(showCardPostings) {
          tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" aria-label="Full name for ${user.username}" value="${escapeHTML(user.fullName || '')}" /></td>
            <td><input type="text" class="form-control form-control-sm" aria-label="Username for ${user.username}" value="${escapeHTML(user.username || '')}" /></td>
            <td><input type="email" class="form-control form-control-sm" aria-label="Email for ${user.username}" value="${escapeHTML(user.email || '')}" /></td>
            <td><input type="tel" class="form-control form-control-sm" aria-label="Phone for ${user.username}" value="${escapeHTML(user.phone || '')}" /></td>
            <td>
              <select class="form-select form-select-sm" aria-label="Role for ${user.username}">
                <option value="cash" ${user.role==='cash' ? 'selected' : ''}>Cash User</option>
                <option value="card" ${user.role==='card' ? 'selected' : ''}>Credit Card Holder</option>
              </select>
            </td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input" aria-label="Is Verified" ${user.isVerified ? 'checked' : ''} />
            </td>
            <td>
              <div class="card-postings-list" aria-label="Credit card postings for ${user.username}">
                ${renderCardPostingsInputs(user.cardPostings || [])}
                <button type="button" class="btn btn-sm btn-outline-primary mt-1 add-card-btn" aria-label="Add card posting for ${user.username}">
                  <i class="bi bi-plus"></i> Add Card
                </button>
              </div>
            </td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input block-checkbox" aria-label="Block user ${user.username}" ${user.blocked ? 'checked' : ''} />
              <span class="block-label">Block</span>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-success me-1 save-user-btn" aria-label="Save user ${user.username}">
                <i class="bi bi-save"></i> Save
              </button>
            </td>
          `;
        } else {
          tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" aria-label="Full name for ${user.username}" value="${escapeHTML(user.fullName || '')}" /></td>
            <td><input type="text" class="form-control form-control-sm" aria-label="Username for ${user.username}" value="${escapeHTML(user.username || '')}" /></td>
            <td><input type="email" class="form-control form-control-sm" aria-label="Email for ${user.username}" value="${escapeHTML(user.email || '')}" /></td>
            <td><input type="tel" class="form-control form-control-sm" aria-label="Phone for ${user.username}" value="${escapeHTML(user.phone || '')}" /></td>
            <td>
              <select class="form-select form-select-sm" aria-label="Role for ${user.username}">
                <option value="cash" ${user.role==='cash' ? 'selected' : ''}>Cash User</option>
                <option value="card" ${user.role==='card' ? 'selected' : ''}>Credit Card Holder</option>
              </select>
            </td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input" aria-label="Is Verified" ${user.isVerified ? 'checked' : ''} />
            </td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input block-checkbox" aria-label="Block user ${user.username}" ${user.blocked ? 'checked' : ''} />
              <span class="block-label">Block</span>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-success me-1 save-user-btn" aria-label="Save user ${user.username}">
                <i class="bi bi-save"></i> Save
              </button>
            </td>
          `;
        }
        tbody.appendChild(tr);
      });
      attachRowEventListeners();
    }
    function escapeHTML(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "'");
    }
    function renderCardPostingsInputs(cardPostings) {
      if(cardPostings.length === 0) return '<p class="text-muted mb-1">No card postings.</p>';
      return cardPostings.map((card, idx) => `
        <div class="card-posting-row d-flex align-items-center" data-index="${idx}">
          <input type="text" class="form-control form-control-sm me-2" placeholder="Bank" aria-label="Bank name" value="${escapeHTML(card.bank)}" required />
          <input type="number" class="form-control form-control-sm me-2" placeholder="Limit (₹)" aria-label="Card limit amount" min="1" value="${card.amount}" required />
          <button type="button" class="btn btn-sm btn-outline-danger remove-card-btn" aria-label="Remove this card posting">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      `).join('');
    }
    function attachRowEventListeners() {
      document.querySelectorAll('.add-card-btn').forEach(btn => {
        btn.onclick = () => {
          const container = btn.parentElement;
          const newCardHTML = `
            <div class="card-posting-row d-flex align-items-center">
              <input type="text" class="form-control form-control-sm me-2" placeholder="Bank" aria-label="Bank name" required />
              <input type="number" class="form-control form-control-sm me-2" placeholder="Limit (₹)" aria-label="Card limit amount" min="1" required />
              <button type="button" class="btn btn-sm btn-outline-danger remove-card-btn" aria-label="Remove this card posting">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>`;
          container.insertAdjacentHTML('beforeend', newCardHTML);
          attachRemoveCardListeners();
        };
      });
      attachRemoveCardListeners();
      document.querySelectorAll('.save-user-btn').forEach(btn => {
        btn.onclick = async () => {
          const row = btn.closest('tr');
          await saveUserRow(row);
        };
      });
      document.querySelectorAll('.block-checkbox').forEach(checkbox => {
        checkbox.onchange = async (e) => {
          const row = e.target.closest('tr');
          const uid = row.dataset.uid;
          const isBlocked = e.target.checked;
          try {
            Swal.fire({
              title: 'Updating block status...',
              didOpen: () => Swal.showLoading(),
              allowOutsideClick: false,
            });
            await firebase.database().ref('users/' + uid).update({ blocked: isBlocked });
            if(allUsers[uid]) allUsers[uid].blocked = isBlocked;
            Swal.close();
            Swal.fire('Success', `User ${isBlocked ? 'blocked' : 'unblocked'} successfully.`, 'success');
            renderUsers();
          } catch(error) {
            Swal.fire('Error', 'Failed to update block status: ' + error.message, 'error');
            e.target.checked = !isBlocked;
          }
        }
      });
    }
    function attachRemoveCardListeners() {
      document.querySelectorAll('.remove-card-btn').forEach(btn => {
        btn.onclick = () => {
          btn.parentElement.remove();
        };
      });
    }
    async function saveUserRow(row) {
      try {
        const uid = row.dataset.uid;
        const fullName = row.querySelector('td:nth-child(1) input').value.trim();
        const username = row.querySelector('td:nth-child(2) input').value.trim();
        const email = row.querySelector('td:nth-child(3) input').value.trim();
        const phone = row.querySelector('td:nth-child(4) input').value.trim();
        const role = row.querySelector('td:nth-child(5) select').value;
        const isVerified = row.querySelector('td:nth-child(6) input[type="checkbox"]').checked;
        const blockCheckbox = row.querySelector('.block-checkbox');
        const blocked = blockCheckbox ? blockCheckbox.checked : false;

        if(!fullName || !username || !email) {
          Swal.fire('Validation Error', 'Full Name, Username, and Email cannot be empty.', 'warning');
          return;
        }
        if(!validateEmail(email)) {
          Swal.fire('Validation Error', 'Please enter a valid email address.', 'warning');
          return;
        }
        if(phone && !validatePhone(phone)) {
          Swal.fire('Validation Error', 'Please enter a valid phone number (digits, +, and spaces allowed).', 'warning');
          return;
        }

        let cardPostings = [];
        if(role === 'card') {
          const startIndex = 7; // Adjusted due to new Phone column
          const cardRows = row.querySelectorAll('.card-posting-row');
          for(const cRow of cardRows) {
            const bank = cRow.querySelector('input[type="text"]').value.trim();
            const amountStr = cRow.querySelector('input[type="number"]').value.trim();
            const amount = Number(amountStr);
            if(!bank || isNaN(amount) || amount < 1) {
              Swal.fire('Validation Error', 'Each card posting must have a bank name and positive limit.', 'warning');
              return;
            }
            cardPostings.push({ bank, amount });
          }
        }

        Swal.fire({
          title: 'Saving...',
          didOpen: () => Swal.showLoading(),
          allowOutsideClick: false,
        });

        await firebase.database().ref('users/' + uid).update({
          fullName,
          username,
          username_lowercase: username.toLowerCase(),
          email,
          phone, // 👈 Saved to Firebase
          role,
          isVerified,
          cardPostings,
          blocked
        });

        Swal.close();
        Swal.fire('Success', `User "${username}" updated successfully.`, 'success');

        allUsers[uid] = {
          fullName,
          username,
          username_lowercase: username.toLowerCase(),
          email,
          phone, // 👈 Updated in local cache
          role,
          isVerified,
          cardPostings,
          blocked
        };

        renderUsers();
      } catch(error) {
        Swal.fire('Error', 'Failed to save user: ' + error.message, 'error');
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validatePhone(phone) {
      // Allow digits, +, -, space, and parentheses
      const re = /^[\+\-KATEX_INLINE_OPENKATEX_INLINE_CLOSE\d\s]*$/;
      return re.test(phone) && phone.length >= 6; // Minimum reasonable length
    }

    searchCashInput.addEventListener('input', renderUsers);
    searchCardInput.addEventListener('input', renderUsers);
    loadUsers();
  </script>
</body>
</html>
