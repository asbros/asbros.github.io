<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Advanced Code Editor</title>
 <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/ace.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
 <!-- Add escomplex library -->
 <script src="https://cdn.jsdelivr.net/npm/escomplex@2.0.0/dist/escomplex.min.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
 <script>
  const firebaseConfig = {
    apiKey: "AIzaSyC3eZdzWCW-z9q1eluk3VCngIRJvyiRMmQ",
    authDomain: "gothic-victor-316412.firebaseapp.com",
    databaseURL: "https://gothic-victor-316412-default-rtdb.firebaseio.com",
    projectId: "gothic-victor-316412",
    storageBucket: "gothic-victor-316412.firebasestorage.app",
    messagingSenderId: "338269379488",
    appId: "1:338269379488:web:75c118b9a27bccc3aaa2c5",
    measurementId: "G-RMXHPZ4EGL"
  };
  firebase.initializeApp(firebaseConfig);
 </script>
 <style>
  #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
  .header { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px; }
  .editor-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 45px; }
  .preview-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; display: none; background: white; z-index: 1000; }
  .floating-btn { position: fixed; bottom: 30px; right: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .settings-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100vh; z-index: 1000; transition: left 0.3s ease; background-color: #f8f9fa; border-right: 1px solid #dee2e6; overflow-y: auto; padding: 20px; padding-bottom: 120px !important;}
  .settings-menu.open { left: 0; }
  .session-item { transition: all 0.2s ease; border-radius: 8px; margin-bottom: 8px; padding: 12px; background: #fff; border: 1px solid #dee2e6; }
  .session-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .session-name { font-weight: 500; color: #2c3e50; }
  .loading-spinner { animation: spin 1s linear infinite; width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; margin: 20px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .empty-state { text-align: center; padding: 20px; color: #95a5a6; }
  #undoBtn, #redoBtn { padding: 5px 10px; }
  .swal2-popup pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; white-space: pre-wrap; }
  .btn-purple {
  background-color: #6f42c1;
  color: white;
  }
  .btn-purple:hover {
  background-color: #5a32a3;
  color: white;
  }
  .metrics-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 10px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    gap: 25px;
    font-size: 0.9em;
    z-index: 999;
  }
  .metric-item { display: flex; align-items: center; gap: 8px; }
  .metric-value { font-weight: 500; color: #2c3e50; }
  .metric-label { color: #95a5a6; }
  .complexity-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
  }
  .low-complexity { background-color: #28a745; }
  .medium-complexity { background-color: #ffc107; }
  .high-complexity { background-color: #dc3545; }
  .ace_read-only .ace_cursor {
  display: none !important;
  }
  .swal2-popup .swal2-loader {
  border-color: #6f42c1 transparent #6f42c1 transparent;
  }
 </style>
</head>

<body>
 <div class="header d-flex justify-content-between align-items-center">
  <h4 class="mb-0">Code Editor</h4>
  <div>
   <button class="btn btn-sm btn-secondary me-2" id="undoBtn" title="Undo" aria-label="Undo">
    <i class="bi bi-arrow-counterclockwise"></i>
   </button>
   <button class="btn btn-sm btn-secondary me-2" id="redoBtn" title="Redo" aria-label="Redo">
    <i class="bi bi-arrow-clockwise"></i>
   </button>
   <button class="btn btn-sm btn-primary" id="togglePreviewBtn">
    <i class="bi bi-layout-split"></i> Show Preview
   </button>
   <button class="btn btn-sm btn-success d-none" id="refreshPreviewBtn">
    <i class="bi bi-arrow-clockwise"></i> Refresh
   </button>
  </div>
 </div>

 <button class="btn btn-primary floating-btn" id="settingsToggleBtn" aria-label="Settings">
  <i class="bi bi-gear"></i>
 </button>

 <div class="settings-menu" id="settingsMenu" role="menu">
  <h4 class="mb-4"><i class="bi bi-gear"></i> Settings</h4>
  <div class="mb-3">
   <label class="form-label">Font Size</label>
   <select class="form-select" id="fontSize">
    <option value="12">12px</option>
    <option value="14">14px</option>
    <option value="16">16px</option>
    <option value="18">18px</option>
    <option value="20">20px</option>
   </select>
  </div>
  <div class="mb-3">
   <label class="form-label">Font Family</label>
   <select class="form-select" id="fontFamily">
    <option value="monospace">Monospace</option>
    <option value="Courier New">Courier New</option>
    <option value="Consolas">Consolas</option>
    <option value="Source Code Pro">Source Code Pro</option>
   </select>
  </div>
  <div class="mb-3">
   <label class="form-label">Theme</label>
   <select class="form-select" id="themeSelect">
    <optgroup label="Light Themes">
     <option value="chrome">Chrome</option>
     <option value="clouds">Clouds</option>
     <option value="crimson_editor">Crimson Editor</option>
    </optgroup>
    <optgroup label="Dark Themes">
     <option value="monokai">Monokai</option>
     <option value="dracula">Dracula</option>
     <option value="tomorrow_night">Tomorrow Night</option>
    </optgroup>
   </select>
  </div>

  <button class="btn text-right btn-primary w-100 mb-3" id="importFromURL">
   <i class="bi bi-globe"></i> Import from URL
  </button>
  <button class="btn btn-success w-100 mb-3" id="saveAndShareBtn">
   <i class="bi bi-share"></i> Save & Share
  </button>
  <button class="btn btn-purple w-100 mb-3" id="getSavedCodeBtn">
   <i class="bi bi-folder2-open"></i> Get Saved Code
  </button>
  <button class="btn btn-info w-100 mb-3" id="downloadCode">
   <i class="bi bi-download"></i> Download Code
  </button>
  <button class="btn btn-warning w-100 mb-3" id="beautifyCode">
   <i class="bi bi-magic"></i> Beautify Code
  </button>
  <button class="btn btn-secondary w-100 mb-3" id="loadFile">
   <i class="bi bi-file-earmark-arrow-up"></i> Load File
  </button>
  <button class="btn btn-purple w-100 mb-3" id="importSessions">
   <i class="bi bi-box-arrow-down"></i> Import Sessions
  </button>
  <button class="btn btn-dark w-100 mb-4" id="saveSession">
   <i class="bi bi-save"></i> Save Session
  </button>
  <h5><i class="bi bi-folder"></i> Saved Sessions</h5>
  <div id="sessionsList" class="sessions-list mb-4">
   <div class="loading-spinner"></div>
  </div>
  <button class="btn btn-success w-100 mb-3" id="exportSessions">
   <i class="bi bi-box-arrow-up"></i> Export All Sessions
  </button>
  <button class="btn btn-info w-100 me-3" id="keyboardControlsBtn" title="Keyboard Shortcuts">
   <i class="bi bi-keyboard"></i> Keyboard Shortcuts
  </button>
 </div>

 <div class="editor-container">
  <div id="editor"></div>
 </div>
 <div class="preview-container">
  <iframe class="w-100 h-100" id="preview"></iframe>
 </div>
 <div class="metrics-footer" id="metricsFooter">
  <div class="metric-item">
   <span class="metric-label">Lines:</span>
   <span class="metric-value" id="lineCount">0</span>
  </div>
  <div class="metric-item">
   <span class="metric-label">Chars:</span>
   <span class="metric-value" id="charCount">0</span>
  </div>
  <div class="metric-item">
   <span class="metric-label">Complexity:</span>
   <span class="complexity-indicator"></span>
   <span class="metric-value" id="complexityValue">-</span>
  </div>
 </div>
 <script>
  const editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.session.setMode("ace/mode/html");
  editor.setOptions({
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      fontSize: 14,
      fontFamily: "monospace",
      useSoftTabs: true,
      wrap: true,
      displayIndentGuides: true,
      highlightGutterLine: true,
      animatedScroll: true,
  });
  ace.require("ace/ext/language_tools");
  editor.setOptions({
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      enableSnippets: true
  });
  
  // Add the keydown event listener here
  document.addEventListener('keydown', (e) => {
      if (!editor.isFocused()) return;
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
          switch(e.key.toLowerCase()) {
              case 's': e.preventDefault(); document.getElementById('saveSession').click(); break;
              case 'z': e.preventDefault(); editor.undo(); break;
              case 'y': e.preventDefault(); editor.redo(); break;
              case 'p': e.preventDefault(); document.getElementById('togglePreviewBtn').click(); break;
              case 'b': e.preventDefault(); document.getElementById('beautifyCode').click(); break;
              case 'd': e.preventDefault(); document.getElementById('downloadCode').click(); break;
          }
      }
  });
  
  // ======== Storage Management Helpers ======== //
  function getLocalStorageSize() {
    let total = 0;
    for (const key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += (localStorage[key].length * 2);
        }
    }
    return total; // Returns size in bytes
  }
  
  function checkStorageLimit() {
    const maxSize = 4.5 * 1024 * 1024; // 4.5MB threshold
    const currentSize = getLocalStorageSize();
    
    if (currentSize >= maxSize) {
        Swal.fire({
            icon: 'warning',
            title: 'Storage Almost Full',
            html: `You've used ${(currentSize/1024/1024).toFixed(2)}MB of 5MB.<br>
                 Delete old sessions to free up space.`,
            confirmButtonText: 'Manage Sessions',
            showCancelButton: true,
            cancelButtonText: 'Dismiss'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('settingsMenu').classList.add('open');
            }
        });
        return true;
    }
    return false;
  }
  
  const savedContent = localStorage.getItem('editorContent');
   editor.setValue(savedContent || "");
  
  function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), timeout);
      };
  }
  
  function updatePreview() {
      const code = editor.getValue();
      localStorage.setItem('editorContent', code);
      const iframe = document.getElementById('preview');
      const blob = new Blob([code], { type: 'text/html' });
      iframe.src = URL.createObjectURL(blob);
  }
  
  const debouncedUpdatePreview = debounce(updatePreview);
  editor.session.on('change', debouncedUpdatePreview);
  
  document.getElementById('undoBtn').addEventListener('click', () => editor.undo());
  document.getElementById('redoBtn').addEventListener('click', () => editor.redo());
  
  let isPreviewVisible = false;
  document.getElementById('togglePreviewBtn').addEventListener('click', () => {
      isPreviewVisible = !isPreviewVisible;
      document.querySelector('.editor-container').style.display = isPreviewVisible ? 'none' : 'block';
      document.querySelector('.preview-container').style.display = isPreviewVisible ? 'block' : 'none';
      document.getElementById('togglePreviewBtn').innerHTML = isPreviewVisible ? 
          '<i class="bi bi-code-square"></i> Show Editor' : 
          '<i class="bi bi-layout-split"></i> Show Preview';
      document.getElementById('refreshPreviewBtn').classList.toggle('d-none', !isPreviewVisible);
      document.getElementById('settingsToggleBtn').style.display = isPreviewVisible ? 'none' : 'block';
      document.getElementById('undoBtn').style.display = isPreviewVisible ? 'none' : 'inline-block';
      document.getElementById('redoBtn').style.display = isPreviewVisible ? 'none' : 'inline-block';
      if(isPreviewVisible) updatePreview();
  });
  
  document.getElementById('refreshPreviewBtn').addEventListener('click', updatePreview);
  document.getElementById('settingsToggleBtn').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.toggle('open');
  });
  
  document.addEventListener('click', (e) => {
      if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsToggleBtn')) {
          document.getElementById('settingsMenu').classList.remove('open');
      }
  });
  
  document.getElementById('fontSize').addEventListener('change', (e) => {
      const fontSize = e.target.value;
      editor.setFontSize(fontSize);
      localStorage.setItem('editorFontSize', fontSize);
  });
  
  document.getElementById('fontFamily').addEventListener('change', (e) => {
      const fontFamily = e.target.value;
      editor.setOptions({ fontFamily });
      localStorage.setItem('editorFontFamily', fontFamily);
      const iframe = document.getElementById('preview');
      iframe.contentDocument.body.style.fontFamily = fontFamily;
  });
  
  document.getElementById('themeSelect').addEventListener('change', (e) => {
      const theme = e.target.value;
      editor.setTheme(`ace/theme/${theme}`);
      localStorage.setItem('editorTheme', theme);
  });
  
  document.getElementById('downloadCode').addEventListener('click', async () => {
      const { value: fileName } = await Swal.fire({
          title: 'Download Code',
          input: 'text',
          inputLabel: 'Enter file name:',
          inputValue: 'code.html',
          showCancelButton: true,
          inputValidator: (value) => !value && 'Please enter a file name!'
      });
      if (fileName) {
          const blob = new Blob([editor.getValue()], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
      }
  });
  
  document.getElementById('beautifyCode').addEventListener('click', () => {
      editor.setValue(html_beautify(editor.getValue()));
  });
  
  document.getElementById('loadFile').addEventListener('click', () => {
      if (checkStorageLimit()) return;
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.html,.css,.js,.txt,.json,.xml';
      input.onchange = (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
  reader.onload = (event) => {
  const sanitized = DOMPurify.sanitize(event.target.result);
  editor.setValue(sanitized);
  // Detect file type
  const ext = file.name.split('.').pop();
  const mode = {
    js: 'javascript',
    css: 'css',
    html: 'html',
    json: 'json',
    xml: 'xml'
  }[ext] || 'text';
  editor.session.setMode(`ace/mode/${mode}`);
  };
          reader.readAsText(file);
      };
      input.click();
  });
  
  // Modified session storage functions
  const SESSION_PREFIX = 'session-';
  
  function saveSession(sessionName) {
    const content = editor.getValue().trim();
    if (!content) return Swal.fire({ 
        icon: 'error', 
        title: 'Empty Content', 
        text: 'Please write something before saving!' 
    });
  
    // Storage check before saving
    if (checkStorageLimit()) return;
  
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
    
    // Auto-delete oldest if over 20 sessions
    if (sessions.length >= 20) {
        const oldestSession = sessions.shift();
        localStorage.removeItem(`${SESSION_PREFIX}${oldestSession}`);
    }
    
    if (sessions.some(s => s.toLowerCase() === sessionName.toLowerCase())) return Swal.fire({ 
        icon: 'error', 
        title: 'Duplicate Name', 
        text: 'Session name already exists!' 
    });
  
    sessions.push(sessionName);
    localStorage.setItem('savedSessions', JSON.stringify(sessions));
    localStorage.setItem(`${SESSION_PREFIX}${sessionName}`, content);
    loadSessionsList();
  
    // Final storage check after saving
    checkStorageLimit();
  }
  
  function loadSessionsList() {
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
    const sessionsList = document.getElementById('sessionsList');
    setTimeout(() => {
        sessionsList.innerHTML = sessions.length > 0 ? sessions.map(session => `
            <div class="session-item">
                <div class="justify-content-between align-items-center">
                    <div style="margin-bottom: 5px;" class="d-flex">
                        <i class="bi bi-file-earmark-code me-2"></i>
                        <span class="session-name" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">${session}</span>
                        <small class="text-muted ms-2">
                            ${(localStorage.getItem(`${SESSION_PREFIX}${session}`)?.length / 1024 || 0).toFixed(1)}KB
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary me-2" onclick="handleSessionClick('${session}')">
                            <i class="bi bi-folder2-open"></i>
                        </button>
                        <button class="btn btn-sm btn-warning me-2" onclick="renameSession('${session}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSession('${session}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>`).join('') : `<div class="empty-state"><i class="bi bi-folder-x fs-4"></i><div class="mt-2">No saved sessions</div></div>`;
    }, 500);
  }
  
  async function handleSessionClick(sessionName) {
      const { isConfirmed } = await Swal.fire({
          title: 'Load Session?',
          text: `Load "${sessionName}"?`,
          icon: 'question',
          showCancelButton: true
      });
      if (isConfirmed) {
          const sessionData = localStorage.getItem(`${SESSION_PREFIX}${sessionName}`);
          if (sessionData) editor.setValue(sessionData);
          Swal.fire({ title: 'Loaded!', text: `"${sessionName}" loaded`, icon: 'success', timer: 2000 });
      }
  }
  
  async function renameSession(oldName) {
      const { value: newName } = await Swal.fire({
          title: 'Rename Session',
          input: 'text',
          inputValue: oldName,
          inputValidator: (value) => !value && 'Name cannot be empty!'
      });
      if (newName && newName !== oldName) {
          const content = localStorage.getItem(`${SESSION_PREFIX}${oldName}`); // Changed to localStorage
    localStorage.setItem(`${SESSION_PREFIX}${newName}`, content); // Changed to localStorage
    localStorage.removeItem(`${SESSION_PREFIX}${oldName}`); // Changed to localStorage
    const sessions = JSON.parse(localStorage.getItem('savedSessions')); // Changed to localStorage
          sessions[sessions.indexOf(oldName)] = newName;
    localStorage.setItem('savedSessions', JSON.stringify(sessions));
          loadSessionsList();
      }
  }
  
  async function deleteSession(sessionName) {
      const { isConfirmed } = await Swal.fire({
          title: 'Delete Session?',
          text: `Delete "${sessionName}" permanently?`,
          icon: 'warning',
          showCancelButton: true
      });
      if (isConfirmed) {
          localStorage.removeItem(`${SESSION_PREFIX}${sessionName}`); // Changed to localStorage
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]') // Changed to localStorage
        .filter(name => name !== sessionName);
    localStorage.setItem('savedSessions', JSON.stringify(sessions)); // Changed to localStorage
          loadSessionsList();
          Swal.fire('Deleted!', 'Session removed', 'success');
      }
  }
  
  document.getElementById('saveSession').addEventListener('click', async () => {
      const { value: sessionName } = await Swal.fire({
          title: 'Save Session',
          input: 'text',
          inputLabel: 'Session name:',
          showCancelButton: true,
          inputValidator: (value) => {if (!value) return 'Name required!';if (value.length > 20) return 'Max 20 characters!';if (/[^a-z0-9]/i.test(value)) return 'Alphanumeric only!';}
      });
      if (sessionName) saveSession(sessionName);
      });
  
      document.addEventListener('DOMContentLoaded', () => {
  loadSessionsList();
  const savedFontSize = localStorage.getItem('editorFontSize') || '14';
  const savedFontFamily = localStorage.getItem('editorFontFamily') || 'monospace';
  const savedTheme = localStorage.getItem('editorTheme') || 'monokai';
  editor.setFontSize(savedFontSize);
  editor.setOptions({ fontFamily: savedFontFamily });
  editor.setTheme(`ace/theme/${savedTheme}`);
  document.getElementById('fontSize').value = savedFontSize;
  document.getElementById('fontFamily').value = savedFontFamily;
  document.getElementById('themeSelect').value = savedTheme;
      });
  
      document.getElementById('importFromURL').addEventListener('click', async () => {
  const { value: url } = await Swal.fire({
      title: 'Import from URL',
      input: 'url',
      inputLabel: 'Website URL:',
      inputPlaceholder: 'https://example.com',
      showCancelButton: true,
      inputValidator: (value) => {
          try { new URL(value); return; } 
          catch { return 'Invalid URL!'; }
      }
  });
  if (url) {
      try {
          Swal.fire({ title: 'Loading...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
          const response = await fetch(proxyUrl + url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          if (!response.headers.get('content-type')?.includes('text/html')) throw new Error('No HTML content');
          const htmlContent = await response.text();
          const sanitized = DOMPurify.sanitize(htmlContent);
          editor.setValue(sanitized);
          Swal.close();
          Swal.fire({ icon: 'success', title: 'Success!', timer: 2000 });
      } catch (error) {
          Swal.fire({ icon: 'error', title: 'Import Failed', html: `<small>${error.message}</small>` });
      }
  }
      });
  
      document.addEventListener('keydown', (e) => {
  if (!editor.isFocused()) return;
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
      switch(e.key.toLowerCase()) {
          case 's': e.preventDefault(); document.getElementById('saveSession').click(); break;
          case 'z': e.preventDefault(); editor.undo(); break;
          case 'y': e.preventDefault(); editor.redo(); break;
      }
  }
      });
 </script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <script>
  function getLocalStorageSize() {
    let total = 0;
    for (const key in localStorage) {
      if (localStorage.hasOwnProperty(key) && 
     (key.startsWith(SESSION_PREFIX) || key === 'editorContent')) {
   total += (localStorage[key].length * 2);
      }
    }
    return total;
  }
  
  document.getElementById('importSessions').addEventListener('click', async () => {
  try {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    
    input.onchange = async (e) => {
      try {
        const file = e.target.files[0];
        if (!file) return;
  
        // Read and parse the file
        const text = await file.text();
        const importedData = JSON.parse(text);
        
        // Validate the imported data
        if (!Array.isArray(importedData)) {
          throw new Error('Invalid session file format. Expected an array of sessions.');
        }
  
        // Get existing sessions or initialize an empty array if none exist
        const existingSessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
        let importedCount = 0;
        let skippedCount = 0;
  
        // Process each session
        for (const session of importedData) {
          // Validate session structure
          if (!session?.name || !session?.content) {
            skippedCount++;
            continue;
          }
  
          // Clean session name
          let cleanName = session.name.trim().slice(0, 20);
          
          // Handle duplicates by appending a counter
          let finalName = cleanName;
          let counter = 1;
          
          while (existingSessions.some(s => s.toLowerCase() === finalName.toLowerCase())) {
            finalName = `${cleanName} (${counter++})`;
          }
  
          // Save the session
          localStorage.setItem(`${SESSION_PREFIX}${finalName}`, session.content);
          existingSessions.push(finalName);
          importedCount++;
        }
  
        // Update the saved sessions list in localStorage
        localStorage.setItem('savedSessions', JSON.stringify(existingSessions));
        
        // Reload the sessions list in the UI
        loadSessionsList();
  
        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Import Complete',
          html: `Imported ${importedCount} sessions<br>
                ${skippedCount} invalid entries skipped`,
          footer: '<small>Duplicate names were automatically renamed</small>'
        });
  
      } catch (error) {
        Swal.fire('Import Failed', error.message, 'error');
      }
    };
  
    // Trigger the file input dialog
    input.click();
  
  } catch (error) {
    Swal.fire('Import Error', error.message, 'error');
  }
  });
  
  document.getElementById('exportSessions').addEventListener('click', () => {
  try {
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || []);
    if (sessions.length === 0) {
      Swal.fire('No Sessions', 'There are no sessions to export.', 'info');
      return;
    }
  
    const data = sessions.map(name => {
      const content = localStorage.getItem(`${SESSION_PREFIX}${name}`);
      return content ? { name, content } : null;
    }).filter(Boolean);
  
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sessions-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    Swal.fire('Exported!', `${data.length} sessions exported.`, 'success');
  } catch (error) {
    Swal.fire('Export Failed', error.message, 'error');
  }
  });
  
  document.getElementById('keyboardControlsBtn').addEventListener('click', () => {
    Swal.fire({
        title: 'Keyboard Controls',
        html: `<div class="text-start">
            <h5>Editor Shortcuts</h5>
            <ul class="list-unstyled">
                <li><kbd>Ctrl/Cmd + S</kbd> - Save current session</li>
                <li><kbd>Ctrl/Cmd + Z</kbd> - Undo</li>
                <li><kbd>Ctrl/Cmd + Y</kbd> - Redo</li>
                <li><kbd>Ctrl/Cmd + F</kbd> - Find</li>
                <li><kbd>Ctrl/Cmd + H</kbd> - Replace</li>
            </ul>
            
            <h5 class="mt-3">Application Shortcuts</h5>
            <ul class="list-unstyled">
                <li><kbd>Ctrl/Cmd + P</kbd> - Toggle preview</li>
                <li><kbd>Ctrl/Cmd + B</kbd> - Beautify code</li>
                <li><kbd>Ctrl/Cmd + D</kbd> - Download code</li>
            </ul>
        </div>`,
        confirmButtonText: 'Close',
        width: '600px'
    });
  });
 </script>
 <script>
  // Update basic metrics
  function updateBasicMetrics() {
    const content = editor.getValue();
    document.getElementById('lineCount').textContent = editor.session.getLength();
    document.getElementById('charCount').textContent = content.length;
  }
  
  // Analyze code complexity
  const analyzeComplexity = debounce(async () => {
    const code = editor.getValue();
    const complexityIndicator = document.querySelector('.complexity-indicator');
    const complexityValue = document.getElementById('complexityValue');
    
    if (!code.trim() || editor.session.getMode().$id !== 'ace/mode/javascript') {
      complexityValue.textContent = '-';
      complexityIndicator.className = 'complexity-indicator';
      return;
    }
  
    try {
      const report = escomplex.analyse(code);
      const complexity = report.aggregate.cyclomatic;
      
      complexityValue.textContent = complexity;
      complexityIndicator.className = `complexity-indicator ${
        complexity <= 5 ? 'low-complexity' :
        complexity <= 10 ? 'medium-complexity' : 'high-complexity'
      }`;
      
      // Show additional metrics on hover
      complexityValue.title = `Halstead Difficulty: ${report.aggregate.halstead.difficulty.toFixed(2)}\n`
                            + `Maintainability: ${report.maintainability.toFixed(2)}`;
    } catch (error) {
      complexityValue.textContent = 'Error';
      complexityIndicator.className = 'complexity-indicator';
    }
  }, 1000);
  
  // Update metrics on content change
  editor.session.on('change', () => {
    updateBasicMetrics();
    analyzeComplexity();
  });
  
  // Initial metrics update
  updateBasicMetrics();
  analyzeComplexity();
  
  // Handle mode changes
  editor.session.on('changeMode', () => {
    analyzeComplexity();
  });
  
  // Add tooltip functionality
  new bootstrap.Tooltip(document.getElementById('complexityValue'), {
    placement: 'top',
    trigger: 'hover',
    customClass: 'metrics-tooltip',
    html: true
  });
 </script>
 <script>
  document.getElementById('saveAndShareBtn').addEventListener('click', async () => {
  // Ask for a name
  const { value: name } = await Swal.fire({
    title: 'Save & Share',
    input: 'text',
    text: 'Enter a name for your code (no special characters or spaces):',
    inputValidator: (value) => {
      if (!value) return 'Name is required!';
      if (/[ .$#\[\]/]/.test(value)) return 'Invalid characters in name!';
    }
  });
  
  // If the user provided a name
  if (name) {
    // Show loader while checking if the name exists and saving
    Swal.fire({
      title: 'Saving...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
  
    try {
      // Normalize the name to lowercase for case-insensitive comparison
      const normalizedName = name.toLowerCase();
  
      // Check if the name already exists in Firebase under the "codes" path (case-insensitive)
      const snapshot = await firebase.database().ref('codes').once('value');
      const codes = snapshot.val() || {};
  
      // Check if any existing key matches the normalized name
      const nameExists = Object.keys(codes).some(
        (key) => key.toLowerCase() === normalizedName
      );
  
      if (nameExists) {
        Swal.close(); // Close the loader
        Swal.fire('Error', 'Name already exists! Please choose a different name.', 'error');
        return;
      }
  
      // Save to Firebase under the "codes" path
      const code = editor.getValue();
      await firebase.database().ref(`codes/${name}`).set({ code });
      const shareLink = `${window.location.origin}${window.location.pathname}?shared=${name}`;
  
      // Copy link to clipboard
      await navigator.clipboard.writeText(shareLink);
  
      // Show success message
      Swal.fire({
        icon: 'success',
        title: 'Saved & Shared!',
        html: `Link copied to clipboard:<br><a href="${shareLink}" target="_blank">${shareLink}</a>`,
        confirmButtonText: 'OK'
      });
    } catch (error) {
      console.error('Firebase Error:', error);
      Swal.fire('Error', `Failed to save to Firebase: ${error.message}`, 'error');
    }
  }
  });
  
  document.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const sharedName = urlParams.get('shared');
  
  if (sharedName) {
    // Disable editor and hide settings
    editor.setReadOnly(true);
    document.getElementById('settingsMenu').style.display = 'none';
    document.getElementById('settingsToggleBtn').style.display = 'none';
    document.getElementById('saveAndShareBtn').style.display = 'none';
  
    // Fetch shared code from Firebase under the "codes" path
    firebase.database().ref(`codes/${sharedName}`).once('value').then((snapshot) => {
      const data = snapshot.val();
      if (data && data.code) {
        editor.setValue(data.code);
      } else {
        Swal.fire('Error', 'Shared code not found.', 'error');
      }
    }).catch(() => {
      Swal.fire('Error', 'Failed to load shared code.', 'error');
    });
  }
  });
  
  document.getElementById('getSavedCodeBtn').addEventListener('click', async () => {
  // Ask for the name of the saved code
  const { value: name } = await Swal.fire({
    title: 'Get Saved Code',
    input: 'text',
    inputLabel: 'Enter the name of the saved code:',
    inputValidator: (value) => {
      if (!value) return 'Name is required!';
    }
  });
  
  if (name) {
    // Normalize the name to lowercase for case-insensitive comparison
    const normalizedName = name.toLowerCase();
  
    try {
      // Fetch all saved codes from Firebase
      const snapshot = await firebase.database().ref('codes').once('value');
      const codes = snapshot.val() || {};
  
      // Find the matching name (case-insensitive)
      const matchedKey = Object.keys(codes).find(
        (key) => key.toLowerCase() === normalizedName
      );
  
      if (matchedKey) {
        // If a match is found, load the code into the editor
        const code = codes[matchedKey].code;
        editor.setValue(code);
  
        // Show success toast
        Swal.fire({
          icon: 'success',
          title: 'Code Loaded!',
          text: `Code "${matchedKey}" has been loaded into the editor.`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
      } else {
        // If no match is found, show an error toast
        Swal.fire({
          icon: 'error',
          title: 'No Code Found',
          text: `No code found with the name "${name}".`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
      }
    } catch (error) {
      console.error('Firebase Error:', error);
      Swal.fire('Error', 'Failed to fetch saved code.', 'error');
    }
  }
  });
 </script>
</body>

</html>