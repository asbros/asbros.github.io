<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Advanced Code Editor</title>
 <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/ace.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
 <!-- Add escomplex library -->
 <script src="https://cdn.jsdelivr.net/npm/escomplex@2.0.0/dist/escomplex.min.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/0.9.0rc1/jspdf.min.js"></script>
 <script>
  const firebaseConfig = {
    apiKey: "AIzaSyC3eZdzWCW-z9q1eluk3VCngIRJvyiRMmQ",
    authDomain: "gothic-victor-316412.firebaseapp.com",
    databaseURL: "https://gothic-victor-316412-default-rtdb.firebaseio.com",
    projectId: "gothic-victor-316412",
    storageBucket: "gothic-victor-316412.firebasestorage.app",
    messagingSenderId: "338269379488",
    appId: "1:338269379488:web:75c118b9a27bccc3aaa2c5",
    measurementId: "G-RMXHPZ4EGL"
  };
  firebase.initializeApp(firebaseConfig);
 </script>
 <style>
  #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
  .header { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px; }
  .editor-container {
  position: fixed;
  top: 60px;
  left: 260px; /* Default position with file explorer visible */
  right: 0;
  bottom: 5px;
  transition: left 0.3s ease-in-out; /* Add transition */
  }
  editor-container.full-width {
  left: 0; /* Full width when file explorer is hidden */
  }
  
  /* Toggle Button */
  #toggleFileExplorerBtn {
  bottom: 75px;
  transition: background-color 0.3s ease-in-out; /* Smooth color change */
  }
  .preview-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; display: none; background: white; z-index: 1000; }
  .floating-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .settings-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100vh; z-index: 1000; transition: left 0.3s ease; background-color: #f8f9fa; border-right: 1px solid #dee2e6; overflow-y: auto; padding: 20px; padding-bottom: 120px !important;}
  .settings-menu.open { left: 0; }
  .session-item { transition: all 0.2s ease; border-radius: 8px; margin-bottom: 8px; padding: 12px; background: #fff; border: 1px solid #dee2e6; }
  .session-item:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .session-name { font-weight: 500; color: #2c3e50; }
  .loading-spinner { animation: spin 1s linear infinite; width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; margin: 20px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .empty-state { text-align: center; padding: 20px; color: #95a5a6; }
  #undoBtn, #redoBtn { padding: 5px 10px; }
  .swal2-popup pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; white-space: pre-wrap; }
  /* Custom styles for the documentation modal */
  .swal2-popup .swal2-html-container {
  text-align: left !important;
  }
  
  .swal2-popup ul, .swal2-popup ol {
  padding-left: 20px;
  }
  
  .swal2-popup h5 {
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #2c3e50;
  }
  
  .swal2-popup kbd {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: monospace;
  color: #6f42c1;
  }
  .btn-purple {
  background-color: #6f42c1;
  color: white;
  }
  .btn-purple:hover {
  background-color: #5a32a3;
  color: white;
  }
  .ace_read-only .ace_cursor {
  display: none !important;
  }
  .swal2-popup .swal2-loader {
  border-color: #6f42c1 transparent #6f42c1 transparent;
  }
  .file-explorer {
  position: fixed;
  top: 60px;
  left: 0;
  width: 260px;
  height: calc(100vh - 60px);
  background-color: #f8f9fa;
  border-right: 1px solid #dee2e6;
  overflow-y: auto;
  z-index: 999;
  transition: transform 0.3s ease-in-out; /* Add transition */
  }
  
  .file-explorer-header {
  padding: 10px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  }
  
  .file-list {
  padding: 10px;
  }
  
  .file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  margin-bottom: 5px;
  background-color: #fff;
  border: 1px solid #dee2e6;
  border-radius: 5px;
  cursor: pointer;
  }
  
  .file-item:hover {
  background-color: #f1f1f1;
  }
  
  .file-item.active {
  background-color: #e2e2e2;
  }
  
  .file-actions {
  display: flex;
  gap: 5px;
  }
  
  .file-actions button {
  padding: 2px 5px;
  font-size: 12px;
  }
  .file-explorer.hidden {
  display: none;
  }
 </style>
</head>

<body>
 <div class="file-explorer">
  <div style="display: inline-block" class="file-explorer-header">
   <h5><i class="bi bi-folder"></i> Files Management</h5>
   <div>
    <button class="btn btn-sm btn-success me-2" id="addFileBtn">
     <i class="bi bi-plus"></i> New File
    </button>
    <button class="btn btn-sm btn-primary" id="uploadFileBtn">
     <i class="bi bi-upload"></i> Upload File
    </button>
   </div>
  </div>
  <div class="file-list" id="fileList">
   <!-- Files will be dynamically added here -->
  </div>
 </div>
 <div class="header d-flex justify-content-between align-items-center">
  <h4 id="htxt" class="mb-0">$ EDITOR</h4>
  <div>
   <button class="btn btn-sm btn-success d-none" id="refreshPreviewBtn">
    <i class="bi bi-arrow-clockwise"></i> Refresh
   </button>
   <button class="btn btn-sm btn-secondary" id="undoBtn">
    <i class="bi bi-arrow-counterclockwise"></i>
   </button>
   <button class="btn btn-sm btn-secondary" id="redoBtn">
    <i class="bi bi-arrow-clockwise"></i>
   </button>
   <button class="btn btn-sm btn-primary" id="togglePreviewBtn">
    <i class="bi bi-layout-split"></i> Show Preview
   </button>
  </div>
 </div>

 <button class="btn btn-primary floating-btn" id="toggleFileExplorerBtn" aria-label="Toggle File Explorer">
  <i class="bi bi-folder"></i>
 </button>
 <button class="btn btn-primary floating-btn" id="settingsToggleBtn" aria-label="Settings">
  <i class="bi bi-gear"></i>
 </button>

 <div class="settings-menu" id="settingsMenu" role="menu">
  <h4 class="mb-4"><i class="bi bi-gear"></i> Settings</h4>
  <div class="mb-3">
   <label class="form-label">Font Size</label>
   <select class="form-select" id="fontSize">
    <option value="12">12px</option>
    <option value="14">14px</option>
    <option value="16">16px</option>
    <option value="18">18px</option>
    <option value="20">20px</option>
   </select>
  </div>
  <div class="mb-3">
   <label class="form-label">Font Family</label>
   <select class="form-select" id="fontFamily">
    <option value="monospace">Monospace</option>
    <option value="Courier New">Courier New</option>
    <option value="Consolas">Consolas</option>
    <option value="Source Code Pro">Source Code Pro</option>
   </select>
  </div>
  <div class="mb-3">
   <label class="form-label">Theme</label>
   <select class="form-select" id="themeSelect">
    <optgroup label="Light Themes">
     <option value="chrome">Chrome</option>
     <option value="clouds">Clouds</option>
     <option value="crimson_editor">Crimson Editor</option>
    </optgroup>
    <optgroup label="Dark Themes">
     <option value="monokai">Monokai</option>
     <option value="dracula">Dracula</option>
     <option value="tomorrow_night">Tomorrow Night</option>
    </optgroup>
   </select>
  </div>

  <button class="btn text-right btn-primary w-100 mb-3" id="importFromURL">
   <i class="bi bi-globe"></i> Import from URL
  </button>
  <button class="btn btn-success w-100 mb-3" id="saveAndShareBtn">
   <i class="bi bi-share"></i> Save & Share
  </button>
  <button class="btn btn-purple w-100 mb-3" id="getSavedCodeBtn">
   <i class="bi bi-folder2-open"></i> Get Saved Code
  </button>
  <button class="btn btn-info w-100 mb-3" id="exportMenuBtn">
   <i class="bi bi-box-arrow-up"></i> Export Code
  </button>
  <button class="btn btn-warning w-100 mb-3" id="beautifyCode">
   <i class="bi bi-magic"></i> Beautify Code
  </button>
  <button class="btn btn-info w-100 mb-3" id="findReplaceBtn">
   <i class="bi bi-search"></i> Find & Replace
  </button>
  <button id="helpBtn" class="btn btn-danger w-100 mb-3">
   <i class="bi bi-question-circle"></i> Help
  </button>
  <button class="btn btn-purple w-100 mb-3" id="importSessions">
   <i class="bi bi-box-arrow-down"></i> Import Sessions
  </button>
  <button class="btn btn-dark w-100 mb-4" id="saveSession">
   <i class="bi bi-save"></i> Save Session
  </button>
  <h5><i class="bi bi-folder"></i> Saved Sessions</h5>
  <div id="sessionsList" class="sessions-list mb-4">
   <div class="loading-spinner"></div>
  </div>
  <button class="btn btn-success w-100 mb-3" id="exportSessions">
   <i class="bi bi-box-arrow-up"></i> Export All Sessions
  </button>
  <button class="btn btn-info w-100 me-3" id="keyboardControlsBtn" title="Keyboard Shortcuts">
   <i class="bi bi-keyboard"></i> Keyboard Shortcuts
  </button>
 </div>

 <div class="editor-container">
  <div id="editor"></div>
 </div>
 <div class="preview-container">
  <iframe class="w-100 h-100" id="preview"></iframe>
 </div>
 <script>
  const editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.session.setMode("ace/mode/html");
  editor.setOptions({
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      fontSize: 14,
      fontFamily: "monospace",
      useSoftTabs: true,
      wrap: true,
      displayIndentGuides: true,
      highlightGutterLine: true,
      animatedScroll: true,
  });
  ace.require("ace/ext/language_tools");
  editor.setOptions({
   enableBasicAutocompletion: true,
   enableLiveAutocompletion: true,
   enableSnippets: true
  });
  
  // Add the keydown event listener here
  document.addEventListener('keydown', (e) => {
   if (!editor.isFocused()) return;
   
   const isCtrlOrCmd = e.ctrlKey || e.metaKey;
   const isShift = e.shiftKey;
   
   if (isCtrlOrCmd && !isShift) {
  switch (e.key.toLowerCase()) {
   case 's':
    e.preventDefault();
    document.getElementById('saveSession').click();
    break;
   case 'z':
    e.preventDefault();
    editor.undo();
    break;
   case 'y':
    e.preventDefault();
    editor.redo();
    break;
   case 'p':
    e.preventDefault();
    document.getElementById('togglePreviewBtn').click();
    break;
   case 'b':
    e.preventDefault();
    document.getElementById('beautifyCode').click();
    break;
   case 'd':
    e.preventDefault();
    exportWithCustomName('txt', exportAsTxt); // Example: Export as TXT
    break;
   case 'f':
    e.preventDefault();
    editor.execCommand('find');
    break;
   case 'h':
    e.preventDefault();
    editor.execCommand('replace');
    break;
   case 'g':
    e.preventDefault();
    editor.execCommand('gotoline');
    break;
   case 'l':
    e.preventDefault();
    editor.execCommand('selectline');
    break;
   case '/':
    e.preventDefault();
    editor.execCommand('togglecomment');
    break;
  }
   }
   
   // Handle navigation shortcuts
   if (isCtrlOrCmd) {
  switch (e.key.toLowerCase()) {
   case 'home':
    e.preventDefault();
    editor.navigateFileStart();
    break;
   case 'end':
    e.preventDefault();
    editor.navigateFileEnd();
    break;
  }
   }
   
   // Handle Alt + Up/Down for moving lines
   if (e.altKey) {
  switch (e.key.toLowerCase()) {
   case 'arrowup':
    e.preventDefault();
    editor.execCommand('movelinesup');
    break;
   case 'arrowdown':
    e.preventDefault();
    editor.execCommand('movelinesdown');
    break;
  }
   }
  });
  
  // ======== Storage Management Helpers ======== //
  function getLocalStorageSize() {
    let total = 0;
    for (const key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += (localStorage[key].length * 2);
        }
    }
    return total; // Returns size in bytes
  }
  
  function checkStorageLimit() {
    const maxSize = 4.5 * 1024 * 1024; // 4.5MB threshold
    const currentSize = getLocalStorageSize();
    
    if (currentSize >= maxSize) {
        Swal.fire({
            icon: 'warning',
            title: 'Storage Almost Full',
            html: `You've used ${(currentSize/1024/1024).toFixed(2)}MB of 5MB.<br>
                 Delete old sessions to free up space.`,
            confirmButtonText: 'Manage Sessions',
            showCancelButton: true,
            cancelButtonText: 'Dismiss'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('settingsMenu').classList.add('open');
            }
        });
        return true;
    }
    return false;
  }
  
  const savedContent = localStorage.getItem('editorContent');
   editor.setValue(savedContent || "");
  
  function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), timeout);
      };
  }
  
  function updatePreview() {
   const code = editor.getValue();
   const iframe = document.getElementById('preview');
   const blob = new Blob([code], { type: 'text/html' });
   iframe.src = URL.createObjectURL(blob);
  }
  
  // Update preview on code change
  editor.session.on('change', debounce(updatePreview, 300));
  
  const debouncedUpdatePreview = debounce(updatePreview);
  editor.session.on('change', debouncedUpdatePreview);
  
  document.getElementById('undoBtn').addEventListener('click', () => editor.undo());
  document.getElementById('redoBtn').addEventListener('click', () => editor.redo());
  
  let isPreviewVisible = false;
  document.getElementById('togglePreviewBtn').addEventListener('click', () => {
      isPreviewVisible = !isPreviewVisible;
      document.querySelector('.editor-container').style.display = isPreviewVisible ? 'none' : 'block';
      document.querySelector('.preview-container').style.display = isPreviewVisible ? 'block' : 'none';
      document.getElementById('togglePreviewBtn').innerHTML = isPreviewVisible ? 
          '<i class="bi bi-code-square"></i> Show Editor' : 
          '<i class="bi bi-layout-split"></i> Show Preview';
      document.getElementById('htxt').innerText = isPreviewVisible ? 
          '$ PREVIEWER' : 
          '$ EDITOR';
      document.getElementById('refreshPreviewBtn').classList.toggle('d-none', !isPreviewVisible);
      document.getElementById('settingsToggleBtn').style.display = isPreviewVisible ? 'none' : 'block';
      document.getElementById('toggleFileExplorerBtn').style.display = isPreviewVisible ? 'none' : 'block';
      document.getElementById('undoBtn').style.display = isPreviewVisible ? 'none' : 'inline-block';
      document.getElementById('redoBtn').style.display = isPreviewVisible ? 'none' : 'inline-block';
      if(isPreviewVisible) updatePreview();
  });
  
  document.getElementById('refreshPreviewBtn').addEventListener('click', updatePreview);
  document.getElementById('settingsToggleBtn').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.toggle('open');
  });
  
  document.addEventListener('click', (e) => {
      if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsToggleBtn')) {
          document.getElementById('settingsMenu').classList.remove('open');
      }
  });
  
  document.getElementById('fontSize').addEventListener('change', (e) => {
      const fontSize = e.target.value;
      editor.setFontSize(fontSize);
      localStorage.setItem('editorFontSize', fontSize);
  });
  
  document.getElementById('fontFamily').addEventListener('change', (e) => {
      const fontFamily = e.target.value;
      editor.setOptions({ fontFamily });
      localStorage.setItem('editorFontFamily', fontFamily);
      const iframe = document.getElementById('preview');
      iframe.contentDocument.body.style.fontFamily = fontFamily;
  });
  
  document.getElementById('themeSelect').addEventListener('change', (e) => {
      const theme = e.target.value;
      editor.setTheme(`ace/theme/${theme}`);
      localStorage.setItem('editorTheme', theme);
  });
  
  document.getElementById('beautifyCode').addEventListener('click', () => {
      editor.setValue(html_beautify(editor.getValue()));
  });
  
  
  // Modified session storage functions
  const SESSION_PREFIX = 'session-';
  
  function saveSession(sessionName) {
    const content = editor.getValue().trim();
    if (!content) return Swal.fire({ 
        icon: 'error', 
        title: 'Empty Content', 
        text: 'Please write something before saving!' 
    });
  
    // Storage check before saving
    if (checkStorageLimit()) return;
  
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
    
    // Auto-delete oldest if over 20 sessions
    if (sessions.length >= 20) {
        const oldestSession = sessions.shift();
        localStorage.removeItem(`${SESSION_PREFIX}${oldestSession}`);
    }
    
    if (sessions.some(s => s.toLowerCase() === sessionName.toLowerCase())) return Swal.fire({ 
        icon: 'error', 
        title: 'Duplicate Name', 
        text: 'Session name already exists!' 
    });
  
    sessions.push(sessionName);
    localStorage.setItem('savedSessions', JSON.stringify(sessions));
    localStorage.setItem(`${SESSION_PREFIX}${sessionName}`, content);
    loadSessionsList();
  
    // Final storage check after saving
    checkStorageLimit();
  }
  
  function loadSessionsList() {
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
    const sessionsList = document.getElementById('sessionsList');
    setTimeout(() => {
        sessionsList.innerHTML = sessions.length > 0 ? sessions.map(session => `
            <div class="session-item">
                <div class="justify-content-between align-items-center">
                    <div style="margin-bottom: 5px;" class="d-flex">
                        <i class="bi bi-file-earmark-code me-2"></i>
                        <span class="session-name" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">${session}</span>
                        <small class="text-muted ms-2">
                            ${(localStorage.getItem(`${SESSION_PREFIX}${session}`)?.length / 1024 || 0).toFixed(1)}KB
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary me-2" onclick="handleSessionClick('${session}')">
                            <i class="bi bi-folder2-open"></i>
                        </button>
                        <button class="btn btn-sm btn-warning me-2" onclick="renameSession('${session}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSession('${session}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>`).join('') : `<div class="empty-state"><i class="bi bi-folder-x fs-4"></i><div class="mt-2">No saved sessions</div></div>`;
    }, 500);
  }
  
  async function handleSessionClick(sessionName) {
      const { isConfirmed } = await Swal.fire({
          title: 'Load Session?',
          text: `Load "${sessionName}"?`,
          icon: 'question',
          showCancelButton: true
      });
      if (isConfirmed) {
          const sessionData = localStorage.getItem(`${SESSION_PREFIX}${sessionName}`);
          if (sessionData) editor.setValue(sessionData);
          Swal.fire({ title: 'Loaded!', text: `"${sessionName}" loaded`, icon: 'success', timer: 2000 });
      }
  }
  
  async function renameSession(oldName) {
      const { value: newName } = await Swal.fire({
          title: 'Rename Session',
          input: 'text',
          inputValue: oldName,
          inputValidator: (value) => !value && 'Name cannot be empty!'
      });
      if (newName && newName !== oldName) {
          const content = localStorage.getItem(`${SESSION_PREFIX}${oldName}`); // Changed to localStorage
    localStorage.setItem(`${SESSION_PREFIX}${newName}`, content); // Changed to localStorage
    localStorage.removeItem(`${SESSION_PREFIX}${oldName}`); // Changed to localStorage
    const sessions = JSON.parse(localStorage.getItem('savedSessions')); // Changed to localStorage
          sessions[sessions.indexOf(oldName)] = newName;
    localStorage.setItem('savedSessions', JSON.stringify(sessions));
          loadSessionsList();
      }
  }
  
  async function deleteSession(sessionName) {
      const { isConfirmed } = await Swal.fire({
          title: 'Delete Session?',
          text: `Delete "${sessionName}" permanently?`,
          icon: 'warning',
          showCancelButton: true
      });
      if (isConfirmed) {
          localStorage.removeItem(`${SESSION_PREFIX}${sessionName}`); // Changed to localStorage
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || '[]') // Changed to localStorage
        .filter(name => name !== sessionName);
    localStorage.setItem('savedSessions', JSON.stringify(sessions)); // Changed to localStorage
          loadSessionsList();
          Swal.fire('Deleted!', 'Session removed', 'success');
      }
  }
  
  document.getElementById('saveSession').addEventListener('click', async () => {
      const { value: sessionName } = await Swal.fire({
          title: 'Save Session',
          input: 'text',
          inputLabel: 'Session name:',
          showCancelButton: true,
          inputValidator: (value) => {if (!value) return 'Name required!';if (value.length > 20) return 'Max 20 characters!';if (/[^a-z0-9]/i.test(value)) return 'Alphanumeric only!';}
      });
      if (sessionName) saveSession(sessionName);
      });
  
      document.addEventListener('DOMContentLoaded', () => {
  loadSessionsList();
  const savedFontSize = localStorage.getItem('editorFontSize') || '14';
  const savedFontFamily = localStorage.getItem('editorFontFamily') || 'monospace';
  const savedTheme = localStorage.getItem('editorTheme') || 'monokai';
  editor.setFontSize(savedFontSize);
  editor.setOptions({ fontFamily: savedFontFamily });
  editor.setTheme(`ace/theme/${savedTheme}`);
  document.getElementById('fontSize').value = savedFontSize;
  document.getElementById('fontFamily').value = savedFontFamily;
  document.getElementById('themeSelect').value = savedTheme;
      });
  
      document.getElementById('importFromURL').addEventListener('click', async () => {
  const { value: url } = await Swal.fire({
      title: 'Import from URL',
      input: 'url',
      inputLabel: 'Website URL:',
      inputPlaceholder: 'https://example.com',
      showCancelButton: true,
      inputValidator: (value) => {
          try { new URL(value); return; } 
          catch { return 'Invalid URL!'; }
      }
  });
  if (url) {
      try {
          Swal.fire({ title: 'Loading...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
          const response = await fetch(proxyUrl + url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          if (!response.headers.get('content-type')?.includes('text/html')) throw new Error('No HTML content');
          const htmlContent = await response.text();
          const sanitized = DOMPurify.sanitize(htmlContent);
          editor.setValue(sanitized);
          Swal.close();
          Swal.fire({ icon: 'success', title: 'Success!', timer: 2000 });
      } catch (error) {
          Swal.fire({ icon: 'error', title: 'Import Failed', html: `<small>${error.message}</small>` });
      }
  }
      });
  
      document.addEventListener('keydown', (e) => {
  if (!editor.isFocused()) return;
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
      switch(e.key.toLowerCase()) {
          case 's': e.preventDefault(); document.getElementById('saveSession').click(); break;
          case 'z': e.preventDefault(); editor.undo(); break;
          case 'y': e.preventDefault(); editor.redo(); break;
      }
  }
      });
 </script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <script>
  function getLocalStorageSize() {
    let total = 0;
    for (const key in localStorage) {
      if (localStorage.hasOwnProperty(key) && 
     (key.startsWith(SESSION_PREFIX) || key === 'editorContent')) {
   total += (localStorage[key].length * 2);
      }
    }
    return total;
  }
  
  document.getElementById('importSessions').addEventListener('click', async () => {
  try {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    
    input.onchange = async (e) => {
      try {
        const file = e.target.files[0];
        if (!file) return;
  
        // Read and parse the file
        const text = await file.text();
        const importedData = JSON.parse(text);
        
        // Validate the imported data
        if (!Array.isArray(importedData)) {
          throw new Error('Invalid session file format. Expected an array of sessions.');
        }
  
        // Get existing sessions or initialize an empty array if none exist
        const existingSessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
        let importedCount = 0;
        let skippedCount = 0;
  
        // Process each session
        for (const session of importedData) {
          // Validate session structure
          if (!session?.name || !session?.content) {
            skippedCount++;
            continue;
          }
  
          // Clean session name
          let cleanName = session.name.trim().slice(0, 20);
          
          // Handle duplicates by appending a counter
          let finalName = cleanName;
          let counter = 1;
          
          while (existingSessions.some(s => s.toLowerCase() === finalName.toLowerCase())) {
            finalName = `${cleanName} (${counter++})`;
          }
  
          // Save the session
          localStorage.setItem(`${SESSION_PREFIX}${finalName}`, session.content);
          existingSessions.push(finalName);
          importedCount++;
        }
  
        // Update the saved sessions list in localStorage
        localStorage.setItem('savedSessions', JSON.stringify(existingSessions));
        
        // Reload the sessions list in the UI
        loadSessionsList();
  
        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Import Complete',
          html: `Imported ${importedCount} sessions<br>
                ${skippedCount} invalid entries skipped`,
          footer: '<small>Duplicate names were automatically renamed</small>'
        });
  
      } catch (error) {
        Swal.fire('Import Failed', error.message, 'error');
      }
    };
  
    // Trigger the file input dialog
    input.click();
  
  } catch (error) {
    Swal.fire('Import Error', error.message, 'error');
  }
  });
  
  document.getElementById('exportSessions').addEventListener('click', () => {
  try {
    const sessions = JSON.parse(localStorage.getItem('savedSessions') || []);
    if (sessions.length === 0) {
      Swal.fire('No Sessions', 'There are no sessions to export.', 'info');
      return;
    }
  
    const data = sessions.map(name => {
      const content = localStorage.getItem(`${SESSION_PREFIX}${name}`);
      return content ? { name, content } : null;
    }).filter(Boolean);
  
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sessions-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    Swal.fire('Exported!', `${data.length} sessions exported.`, 'success');
  } catch (error) {
    Swal.fire('Export Failed', error.message, 'error');
  }
  });
  
  document.getElementById('keyboardControlsBtn').addEventListener('click', () => {
   Swal.fire({
  title: 'Keyboard Controls',
  html: `
            <div class="text-start">
                <h5>Editor Shortcuts</h5>
                <ul class="list-unstyled">
                    <li><kbd>Ctrl/Cmd + S</kbd> - Save current session</li>
                    <li><kbd>Ctrl/Cmd + Z</kbd> - Undo</li>
                    <li><kbd>Ctrl/Cmd + Y</kbd> - Redo</li>
                    <li><kbd>Ctrl/Cmd + P</kbd> - Toggle preview</li>
                    <li><kbd>Ctrl/Cmd + B</kbd> - Beautify code</li>
                    <li><kbd>Ctrl/Cmd + D</kbd> - Download code</li>
                </ul>
  
                <h5 class="mt-3">Ace Editor Shortcuts</h5>
                <ul class="list-unstyled">
                    <li><kbd>Ctrl/Cmd + F</kbd> - Find</li>
                    <li><kbd>Ctrl/Cmd + H</kbd> - Replace</li>
                    <li><kbd>Ctrl/Cmd + G</kbd> - Go to line</li>
                    <li><kbd>Ctrl/Cmd + L</kbd> - Select line</li>
                    <li><kbd>Ctrl/Cmd + /</kbd> - Toggle comment</li>
                </ul>
  
                <h5 class="mt-3">Navigation Shortcuts</h5>
                <ul class="list-unstyled">
                    <li><kbd>Ctrl/Cmd + Home</kbd> - Go to start of document</li>
                    <li><kbd>Ctrl/Cmd + End</kbd> - Go to end of document</li>
                    <li><kbd>Alt + Up/Down</kbd> - Move line up/down</li>
                </ul>
            </div>
        `,
  confirmButtonText: 'Close',
  width: '600px'
   });
  });
 </script>
 <script>
  document.getElementById('saveAndShareBtn').addEventListener('click', async () => {
    const content = editor.getValue().trim();
  
    // Check if editor is empty
    if (!content) {
        Swal.fire({
            icon: 'error',
            title: 'Empty Content',
            text: 'Please write something before saving and sharing!'
        });
        return;
    }
  
    // Get name from user
    const { value: name } = await Swal.fire({
        title: 'Save & Share',
        input: 'text',
        text: 'Enter a name for your code (no special characters or spaces):',
        inputValidator: (value) => {
            if (!value) return 'Name is required!';
            if (/[ .$#\[\]/]/.test(value)) return 'Invalid characters in name!';
        }
    });
  
    if (name) {
        const uppercaseName = name.toUpperCase();
  
        try {
            // Check if name already exists in Firebase
            const snapshot = await firebase.database().ref(`codes/${uppercaseName}`).once('value');
            if (snapshot.exists()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Name Exists',
                    text: 'This name is already taken! Please use a different name.'
                });
                return;
            }
  
            // Get permissions if name is unique
            const { value: permission } = await Swal.fire({
                title: 'Set Permissions',
                input: 'select',
                inputOptions: { edit: 'Allow Editing', view: 'View Only' },
                inputLabel: 'Choose sharing permissions:',
                showCancelButton: true
            });
  
            if (permission) {
                Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                // Save to Firebase
                await firebase.database().ref(`codes/${uppercaseName}`).set({ 
                    code: editor.getValue(), 
                    permission 
                });
  
                // Generate and copy share link
                const shareLink = `${window.location.origin}${window.location.pathname}?shared=${uppercaseName}`;
                await navigator.clipboard.writeText(shareLink);
  
                Swal.fire({
                    icon: 'success',
                    title: 'Saved & Shared!',
                    html: `Link copied to clipboard:<br><a href="${shareLink}" target="_blank">${shareLink}</a>`
                });
            }
        } catch (error) {
            console.error('Firebase Error:', error);
            Swal.fire('Error', `Operation failed: ${error.message}`, 'error');
        }
    }
  });
  
  document.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const sharedName = urlParams.get('shared');
  
  if (sharedName) {
    firebase.database().ref(`codes/${sharedName}`).once('value')
      .then((snapshot) => {
        const data = snapshot.val();
        if (data && data.code) {
          editor.setValue(data.code);
          if (data.permission === 'view') {
            editor.setReadOnly(true);
            Swal.fire('Info', 'This code is view-only. Editing is disabled.', 'info');
          }
        } else {
          Swal.fire('Error', 'Shared code not found.', 'error');
        }
      })
      .catch((error) => {
        console.error('Firebase Error:', error);
        Swal.fire('Error', 'Failed to load shared code. Please try again later.', 'error');
      });
  }
  });
  
  document.getElementById('getSavedCodeBtn').addEventListener('click', async () => {
  // Ask for the name of the saved code
  const { value: name } = await Swal.fire({
    title: 'Get Saved Code',
    input: 'text',
    inputLabel: 'Enter the name of the saved code:',
    inputValidator: (value) => {
      if (!value) return 'Name is required!';
    }
  });
  
  if (name) {
    // Normalize the name to lowercase for case-insensitive comparison
    const normalizedName = name.toLowerCase();
  
    try {
      // Fetch all saved codes from Firebase
      const snapshot = await firebase.database().ref('codes').once('value');
      const codes = snapshot.val() || {};
  
      // Find the matching name (case-insensitive)
      const matchedKey = Object.keys(codes).find(
        (key) => key.toLowerCase() === normalizedName
      );
  
      if (matchedKey) {
        // If a match is found, load the code into the editor
        const code = codes[matchedKey].code;
        editor.setValue(code);
  
        // Show success toast
        Swal.fire({
          icon: 'success',
          title: 'Code Loaded!',
          text: `Code "${matchedKey}" has been loaded into the editor.`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
      } else {
        // If no match is found, show an error toast
        Swal.fire({
          icon: 'error',
          title: 'No Code Found',
          text: `No code found with the name "${name}".`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
      }
    } catch (error) {
      console.error('Firebase Error:', error);
      Swal.fire('Error', 'Failed to fetch saved code.', 'error');
    }
  }
  });
 </script>
 <script>
  // Detect big screens
  function isBigScreen() {
      return window.matchMedia('(min-width: 1024px)').matches;
  }
  
  // Adjust layout based on screen size
  function adjustLayout() {
      const editorContainer = document.querySelector('.editor-container');
      const previewContainer = document.querySelector('.preview-container');
      const toggleButton = document.getElementById('togglePreviewBtn');
      const refreshButton = document.getElementById('refreshPreviewBtn');
  
      if (isBigScreen()) {
     // Split layout for big screens
     editorContainer.style.width = '50%';
     previewContainer.style.display = 'block';
     toggleButton.style.display = 'none';
     refreshButton.style.display = 'none';
      } else {
     // Single layout for small screens
     editorContainer.style.width = '100%';
     previewContainer.style.display = 'none';
     toggleButton.style.display = 'inline-block';
     refreshButton.style.display = 'inline-block';
      }
  }
  
  // Update preview in real-time
  function updatePreview() {
      const code = editor.getValue();
      const iframe = document.getElementById('preview');
      const blob = new Blob([code], { type: 'text/html' });
      iframe.src = URL.createObjectURL(blob);
  }
  
  // Debounce function for performance
  function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
     clearTimeout(timer);
     timer = setTimeout(() => func.apply(this, args), timeout);
      };
  }
  
  const debouncedUpdatePreview = debounce(updatePreview);
  editor.session.on('change', debouncedUpdatePreview);
  
  // Adjust layout and buttons on page load and window resize
  window.addEventListener('resize', adjustLayout);
  adjustLayout(); // Initial adjustment
  updatePreview(); // Initial preview update
 </script>

 <script>
  // Utility function for custom file names
  async function exportWithCustomName(format, exportFunction) {
      const { value: fileName } = await Swal.fire({
     title: 'Export Code',
     input: 'text',
     inputLabel: 'Enter file name:',
     inputValue: `code.${format}`,
     showCancelButton: true,
     inputValidator: (value) => !value && 'Please enter a file name!'
      });
      if (fileName) {
     exportFunction(fileName);
      }
  }
  
  // Utility function to check if the editor is empty
  function isEditorEmpty() {
   return editor.getValue().trim() === '';
  }
  
  // Show an alert if the editor is empty
  function alertEditorEmpty() {
   Swal.fire({
  icon: 'error',
  title: 'Empty Editor',
  text: 'Please write something in the editor before exporting!',
   });
  }
  
  // Export as TXT
  function exportAsTxt(fileName = 'code.txt') {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   const code = editor.getValue();
   const blob = new Blob([code], { type: 'text/plain' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = fileName;
   a.click();
   URL.revokeObjectURL(url);
  }
  
  // Export as HTML
  function exportAsHtml(fileName = 'code.html') {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   const code = editor.getValue();
   const htmlContent = `
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exported Code</title>
  </head>
  <body>
    <pre>${code}</pre>
  </body>
  </html>
    `;
   const blob = new Blob([htmlContent], { type: 'text/html' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = fileName;
   a.click();
   URL.revokeObjectURL(url);
  }
  
  // Export as PDF
  function exportAsPdf(fileName = 'code.pdf') {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   const code = editor.getValue();
   const doc = new jsPDF();
   doc.setFontSize(12);
   doc.text(code, 10, 10);
   doc.save(fileName);
  }
  
  // Export as Markdown
  function exportAsMarkdown(fileName = 'code.md') {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   const code = editor.getValue();
   const blob = new Blob([code], { type: 'text/markdown' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = fileName;
   a.click();
   URL.revokeObjectURL(url);
  }
  
  // Export as JSON
  function exportAsJson(fileName = 'code.json') {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   const code = editor.getValue();
   const json = JSON.stringify({ code }, null, 2);
   const blob = new Blob([json], { type: 'application/json' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = fileName;
   a.click();
   URL.revokeObjectURL(url);
  }
  
  // Export as Image
  function exportAsImage(format = 'png', fileName = `code.${format}`) {
   if (isEditorEmpty()) {
  alertEditorEmpty();
  return;
   }
   html2canvas(document.querySelector('#editor')).then(canvas => {
  const imgData = canvas.toDataURL(`image/${format}`);
  const a = document.createElement('a');
  a.href = imgData;
  a.download = fileName;
  a.click();
   });
  }
  
  // Export menu
  document.getElementById('exportMenuBtn').addEventListener('click', () => {
   Swal.fire({
  title: 'Export Code',
  html: `
            <div class="mb-3">
                <label class="form-label">Select Format</label>
                <select class="form-select" id="exportFormat">
                    <option value="pdf">PDF</option>
                    <option value="markdown">Markdown</option>
                    <option value="json">JSON</option>
                    <option value="txt">TXT</option>
                    <option value="html">HTML</option>
                    <option value="png">PNG</option>
                    <option value="jpeg">JPEG</option>
                </select>
            </div>
        `,
  showCancelButton: true,
  confirmButtonText: 'Export',
  preConfirm: () => {
   const format = document.getElementById('exportFormat').value;
   return format;
  }
   }).then((result) => {
  if (result.isConfirmed) {
   const format = result.value;
   switch (format) {
    case 'pdf':
     exportWithCustomName('pdf', exportAsPdf);
     break;
    case 'markdown':
     exportWithCustomName('md', exportAsMarkdown);
     break;
    case 'json':
     exportWithCustomName('json', exportAsJson);
     break;
    case 'txt':
     exportWithCustomName('txt', exportAsTxt);
     break;
    case 'html':
     exportWithCustomName('html', exportAsHtml);
     break;
    case 'png':
     exportWithCustomName('png', (fileName) => exportAsImage('png', fileName));
     break;
    case 'jpeg':
     exportWithCustomName('jpeg', (fileName) => exportAsImage('jpeg', fileName));
     break;
   }
  }
   });
  });
  
  //Find & Replace
  document.getElementById('findReplaceBtn').addEventListener('click', async () => {
   // Ask the user for the word to find
   const { value: findWord } = await Swal.fire({
  title: 'Find & Replace',
  html: `
            <input type="text" id="findWord" class="swal2-input" placeholder="Word to find...">
            <label for="regexToggle" style="display: flex; align-items: center; margin-top: 10px;">
                <input type="checkbox" id="regexToggle" style="margin-right: 5px;"> Use Regular Expression
            </label>
        `,
  focusConfirm: false,
  showCancelButton: true,
  preConfirm: () => {
   const findWord = document.getElementById('findWord').value;
   const useRegex = document.getElementById('regexToggle').checked;
   if (!findWord) {
    Swal.showValidationMessage('Please enter a word to find!');
   }
   return { findWord, useRegex };
  }
   });
   
   if (!findWord) return; // Exit if the user cancels or doesn't enter a word
   
   // Ask the user for the word to replace with
   const { value: replaceWord } = await Swal.fire({
  title: 'Find & Replace',
  input: 'text',
  inputLabel: 'Enter the word to replace with:',
  inputPlaceholder: 'Word to replace with...',
  showCancelButton: true,
  inputValidator: (value) => {
   if (!value) return 'Please enter a word to replace with!';
  }
   });
   
   if (!replaceWord) return; // Exit if the user cancels or doesn't enter a word
   
   // Ask the user whether to replace the first occurrence or all occurrences
   const { value: replaceAll } = await Swal.fire({
  title: 'Find & Replace',
  input: 'radio',
  inputOptions: {
   first: 'Replace first occurrence',
   all: 'Replace all occurrences'
  },
  inputValidator: (value) => {
   if (!value) return 'Please select an option!';
  }
   });
   
   if (!replaceAll) return; // Exit if the user cancels or doesn't select an option
   
   // Perform the find and replace operation
   performFindAndReplace(findWord.findWord, replaceWord, replaceAll, findWord.useRegex);
  });
  
  // Function to perform the find and replace operation
  function performFindAndReplace(findWord, replaceWord, replaceAll, useRegex) {
   const editorContent = editor.getValue();
   
   let regex;
   if (useRegex) {
  try {
   // Create a regex object from the user's input
   regex = new RegExp(findWord, replaceAll === 'all' ? 'g' : '');
  } catch (error) {
   Swal.fire({
    icon: 'error',
    title: 'Invalid Regex',
    text: 'The regular expression is invalid. Please check your syntax.',
   });
   return;
  }
   } else {
  // Escape special characters if not using regex
  const escapedFindWord = findWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  regex = new RegExp(escapedFindWord, replaceAll === 'all' ? 'g' : '');
   }
   
   // Check if the word to find exists in the editor content
   if (!regex.test(editorContent)) {
  Swal.fire({
   icon: 'error',
   title: 'Word Not Found',
   text: `The word "${findWord}" was not found in the editor.`,
  });
  return; // Exit the function if the word is not found
   }
   
   // Perform the replacement
   const newContent = editorContent.replace(regex, replaceWord);
   
   // Update the editor with the new content
   editor.setValue(newContent);
   
   // Show a success message
   Swal.fire({
  icon: 'success',
  title: 'Find & Replace Complete',
  text: `Replaced "${findWord}" with "${replaceWord}" (${replaceAll === 'first' ? 'first occurrence' : 'all occurrences'}).`,
   });
  }
  
  //help Button
  document.getElementById('helpBtn').addEventListener('click', () => {
  Swal.fire({
    title: 'Documentation',
    html: `
      <div class="text-start">
        <h5>Features</h5>
        <ul>
          <li>Real-time code editing with syntax highlighting.</li>
          <li>Preview HTML output in real-time.</li>
          <li>Save and load code sessions locally.</li>
          <li>Export code as PDF, Markdown, JSON, TXT, HTML, or image.</li>
          <li>Find and replace functionality with regex support.</li>
          <li>Keyboard shortcuts for common actions.</li>
        </ul>
  
        <h5 class="mt-4">Keyboard Shortcuts</h5>
        <ul>
          <li><kbd>Ctrl/Cmd + S</kbd> - Save current session</li>
          <li><kbd>Ctrl/Cmd + Z</kbd> - Undo</li>
          <li><kbd>Ctrl/Cmd + Y</kbd> - Redo</li>
          <li><kbd>Ctrl/Cmd + P</kbd> - Toggle preview</li>
          <li><kbd>Ctrl/Cmd + B</kbd> - Beautify code</li>
          <li><kbd>Ctrl/Cmd + F</kbd> - Find</li>
          <li><kbd>Ctrl/Cmd + H</kbd> - Replace</li>
          <li><kbd>Ctrl/Cmd + D</kbd> - Download code</li>
        </ul>
  
        <h5 class="mt-4">Usage Instructions</h5>
        <ol>
          <li>Write your code in the editor.</li>
          <li>Use the "Show Preview" button to see the output.</li>
          <li>Save your code using "Save Session" or export it using "Export Code".</li>
          <li>Use the settings menu to customize the editor (font size, theme, etc.).</li>
        </ol>
      </div>
    `,
    width: '800px',
    confirmButtonText: 'Close',
  });
  });
  
  // File Explorer Logic
  const fileExplorer = {
   files: [], // Array to store file data
   currentFile: null, // Currently active file
  
   // Initialize file explorer
   init() {
      this.loadFiles();
      this.renderFileList();
      this.setupEventListeners();
   },
  
   // Load files from localStorage
   loadFiles() {
      const savedFiles = JSON.parse(localStorage.getItem('files')) || [];
      this.files = savedFiles;
      if (this.files.length > 0) {
         this.currentFile = this.files[0].id;
         editor.setValue(this.files[0].content);
      }
   },
  
   // Save files to localStorage
   saveFiles() {
      localStorage.setItem('files', JSON.stringify(this.files));
   },
  
   // Render file list in the sidebar
   renderFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = this.files
         .map(
            (file) => `
            <div class="file-item ${file.id === this.currentFile ? 'active' : ''}" data-id="${file.id}">
               <span style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;" class="file-name">${file.name}</span>
               <div class="file-actions">
                  <button class="btn btn-sm btn-warning rename-file" title="Rename">
                     <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger delete-file" title="Delete">
                     <i class="bi bi-trash"></i>
                  </button>
               </div>
            </div>
         `
         )
         .join('');
   },
  
   // Add a new file
   addFile(name = 'Untitled', content = '') {
      const newFile = {
         id: Date.now().toString(),
         name: name,
         content: content,
      };
      this.files.push(newFile);
      this.currentFile = newFile.id;
      this.saveFiles();
      this.renderFileList();
      editor.setValue(content);
   },
  
   // Rename a file
   renameFile(fileId, newName) {
      const file = this.files.find((f) => f.id === fileId);
      if (file) {
         file.name = newName;
         this.saveFiles();
         this.renderFileList();
      }
   },
  
   // Delete a file
   deleteFile(fileId) {
      this.files = this.files.filter((f) => f.id !== fileId);
      if (this.currentFile === fileId) {
         this.currentFile = this.files.length > 0 ? this.files[0].id : null;
         editor.setValue(this.files.length > 0 ? this.files[0].content : '');
      }
      this.saveFiles();
      this.renderFileList();
   },
  
   // Switch to a file
   switchFile(fileId) {
      const file = this.files.find((f) => f.id === fileId);
      if (file) {
         this.currentFile = fileId;
         editor.setValue(file.content);
         this.renderFileList();
      }
   },
  
   // Save current file content
   saveCurrentFile() {
      const file = this.files.find((f) => f.id === this.currentFile);
      if (file) {
         file.content = editor.getValue();
         this.saveFiles();
      }
   },
  
   // Set up event listeners
   setupEventListeners() {
      // Add new file
      document.getElementById('addFileBtn').addEventListener('click', () => {
         this.addFile();
      });
  
      // Upload file
      document.getElementById('uploadFileBtn').addEventListener('click', () => {
         const input = document.createElement('input');
         input.type = 'file';
         input.accept = '.html,.css,.js,.txt,.json,.md,.pdf,.png,.jpeg,.jpg'; // Accept all supported file types
         input.multiple = true; // Allow multiple files to be uploaded
  
         input.onchange = (e) => {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
               const file = files[i];
               const reader = new FileReader();
  
               reader.onload = (event) => {
                  const fileContent = event.target.result;
                  if (file.type.startsWith('image/')) {
                     // Handle image files (e.g., display them in the preview)
                     this.addFile(file.name, `<img src="${fileContent}" alt="${file.name}">`);
                  } else {
                     // Handle text-based files
                     this.addFile(file.name, fileContent);
                  }
               };
  
               reader.readAsText(file); // Read the file as text
            }
         };
  
         input.click(); // Trigger the file input dialog
      });
  
      // Switch file
      document.getElementById('fileList').addEventListener('click', (e) => {
         const fileItem = e.target.closest('.file-item');
         if (fileItem) {
            const fileId = fileItem.dataset.id;
            this.switchFile(fileId);
         }
      });
  
      // Rename file
      document.getElementById('fileList').addEventListener('click', (e) => {
         if (e.target.closest('.rename-file')) {
            const fileItem = e.target.closest('.file-item');
            const fileId = fileItem.dataset.id;
            const file = this.files.find((f) => f.id === fileId);
            Swal.fire({
               title: 'Rename File',
               input: 'text',
               inputValue: file.name,
               showCancelButton: true,
               inputValidator: (value) => {
                  if (!value) return 'File name cannot be empty!';
               },
            }).then((result) => {
               if (result.isConfirmed) {
                  this.renameFile(fileId, result.value);
               }
            });
         }
      });
  
      // Delete file
      document.getElementById('fileList').addEventListener('click', (e) => {
         if (e.target.closest('.delete-file')) {
            const fileItem = e.target.closest('.file-item');
            const fileId = fileItem.dataset.id;
            Swal.fire({
               title: 'Delete File?',
               text: 'This action cannot be undone!',
               icon: 'warning',
               showCancelButton: true,
               confirmButtonText: 'Delete',
            }).then((result) => {
               if (result.isConfirmed) {
                  this.deleteFile(fileId);
               }
            });
         }
      });
  
      // Save file content on editor change
      editor.session.on('change', () => {
         this.saveCurrentFile();
      });
   },
  };
  
  // Initialize file explorer
  fileExplorer.init();
  
  //toggle file explorer
  document.getElementById('toggleFileExplorerBtn').addEventListener('click', () => {
  const fileExplorer = document.querySelector('.file-explorer');
  fileExplorer.classList.toggle('hidden');
  document.getElementById('toggleFileExplorerBtn').classList.toggle('active');
  
  const editorContainer = document.querySelector('.editor-container');
  if (fileExplorer.classList.contains('hidden')) {
    editorContainer.style.left = '0';
  } else {
    editorContainer.style.left = '260px';
  }
  });
 </script>
</body>

</html>