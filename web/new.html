<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cash ↔ Credit Card Portal</title>
  <!-- Bootstrap 5.3.3, Bootstrap Icons, SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { background: #f3f8ff;}
    .navbar { background: linear-gradient(90deg, #4233a0 0%, #6372ff 100%); }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-text, .navbar .dropdown-toggle { color: #fff !important; }
    .navbar .dropdown-menu { right:0; left:auto; }
    .dashboard-section { min-height: 60vh; }
    .profile-card { max-width: 400px; border-radius: 1rem; margin: auto; }
    .profile-avatar { width: 70px; height: 70px; object-fit: cover; border-radius: 50%; border: 2px solid #4233a0; background: #fff;}
    .credit-card-info { border-radius: 10px; background: #e3eaff; margin: 8px 0; padding: 10px;}
    .credit-card-info .actions { float: right; }
    .credit-card-info .actions button { margin-left: 6px; }
    .bg-header { background: linear-gradient(90deg, #4233a0 0%, #6372ff 100%); color: #fff; }
    @media (max-width:700px) { .profile-card { max-width: 97vw;} }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">Cash ↔ Credit Card</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navBarContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navBarContent">
        <ul class="navbar-nav ms-auto align-items-center" id="navLoggedOut" style="display:flex;">
          <li class="nav-item">
            <button class="btn btn-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
          </li>
        </ul>
        <!-- Logged In Nav -->
        <ul class="navbar-nav ms-auto align-items-center" id="navLoggedIn" style="display:none;">
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle d-flex align-items-center" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="https://i.pravatar.cc/70?u=cardholder" id="navAvatar" class="rounded-circle me-1" width="32" height="32"/><span id="navUsername"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li class="dropdown-item-text"><b id="navRole"></b></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item text-danger" onclick="logout()">Logout</button></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container py-3 dashboard-section">
    <div id="dashboard" style="display:none">
      <div class="row">
        <!-- Profile Section -->
        <div class="col-md-4 mb-4">
          <div class="card shadow profile-card">
            <div class="card-body text-center">
              <img id="profileAvatar" src="https://i.pravatar.cc/100?u=404" class="profile-avatar mb-2" />
              <div class="h5 mb-0" id="profileName"></div>
              <small id="profileUsername" class="text-muted"></small>
              <hr>
              <span class="badge rounded-pill bg-primary" id="profileRoleBADGE"></span>
              <div id="profileCardDetails" class="mt-3"></div>
            </div>
          </div>
        </div>
        <!-- Dashboard Actions -->
        <div class="col-md-8" id="dashboardContent"></div>
      </div>
    </div>
    <!-- Home Section for guests -->
    <div id="homeSection">
      <div class="text-center py-5">
        <h1 class="display-5">Welcome to Cash ↔ Credit Card Platform</h1>
        <p class="lead">Want to turn your cash into credit or help others while earning? Connect safely, instantly.</p>
        <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
        <button class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="registerForm" autocomplete="off">
        <div class="modal-header bg-header">
          <h5 class="modal-title">Register Account</h5>
          <button type="button" class="btn-close bg-light" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="regFullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" required id="regFullName" />
          </div>
          <div class="mb-3">
            <label for="regUsername" class="form-label">Username</label>
            <input type="text" class="form-control" required id="regUsername" pattern="^[A-Za-z0-9_]+$" />
            <div class="form-text">Alphanumeric, underscores only, unique (case-insensitive)</div>
          </div>
          <div class="mb-3">
            <label for="regEmail" class="form-label">Email</label>
            <input type="email" class="form-control" required id="regEmail" />
          </div>
          <div class="mb-3">
            <label for="regPassword" class="form-label">Password</label>
            <input type="password" class="form-control" required id="regPassword" minlength="6" />
          </div>
          <div class="mb-3">
            <label class="form-label">Register As</label>
            <select class="form-select" required id="regRole">
              <option value="" disabled selected>Select Role</option>
              <option value="cash">Cash User</option>
              <option value="card">Credit Card Holder</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Register</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="loginForm" autocomplete="off">
        <div class="modal-header bg-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close bg-light" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="loginUsername" class="form-label">Username</label>
            <input type="text" class="form-control" required id="loginUsername" />
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" required id="loginPassword" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase Initialization -->
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCxJqJadOqmVA9XHUEnf_bzY8_j9WhoOsc",
      authDomain: "chat-ebbc6.firebaseapp.com",
      databaseURL: "https://chat-ebbc6-default-rtdb.firebaseio.com",
      projectId: "chat-ebbc6",
      storageBucket: "chat-ebbc6.appspot.com",
      messagingSenderId: "900704224803",
      appId: "1:900704224803:web:849180c787132c7baa1396",
      measurementId: "G-YYNMD5MS6M"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUserUID = null;  // Keep track of logged in UID

    // Show/hide navbar for login state
    function showNavLoggedIn(userObj) {
      document.getElementById('navLoggedOut').style.display = 'none';
      document.getElementById('navLoggedIn').style.display = '';
      document.getElementById('navUsername').textContent = userObj.username;
      document.getElementById('navAvatar').src = "https://i.pravatar.cc/70?u=" + userObj.username;
      document.getElementById('navRole').innerHTML = (userObj.role === "cash" ? 'Cash User' : 'Credit Card Holder');
    }
    function showNavLoggedOut() {
      document.getElementById('navLoggedOut').style.display = '';
      document.getElementById('navLoggedIn').style.display = 'none';
    }

    // Register user
    document.getElementById('registerForm').onsubmit = async function(e) {
      e.preventDefault();
      let fullName = regFullName.value.trim();
      let username_plain = regUsername.value.trim();
      let username = username_plain.toLowerCase();
      let email = regEmail.value.trim();
      let password = regPassword.value;
      let role = regRole.value;
      if(!(/^[A-Za-z0-9_]+$/.test(username_plain))) {
        Swal.fire("Username may only use letters, numbers, underscores"); return;
      }
      let snap = await firebase.database().ref("users").orderByChild("username_lowercase").equalTo(username).once("value");
      if (snap.exists()) {
        Swal.fire({ icon: "error", title: "Username taken!", text: "Please choose another (case-insensitive) username." });
        return;
      }
      try {
        let cred = await firebase.auth().createUserWithEmailAndPassword(email, password);
        let userObj = {
          fullName, username: username_plain, username_lowercase: username,
          email, role, avatar: "https://i.pravatar.cc/100?u="+username_plain
        };
        await firebase.database().ref("users/" + cred.user.uid).set(userObj);
        Swal.fire({ icon: "success", title: "Registered!", text: "Registration successful. Please login." });
        bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
      } catch (error) {
        Swal.fire({ icon: "error", title: "Registration failed", text: error.message });
      }
    };

    // Login user via username->email map
    document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      let username = loginUsername.value.trim().toLowerCase();
      let password = loginPassword.value;
      let snap = await firebase.database().ref("users").orderByChild("username_lowercase").equalTo(username).once("value");
      if (!snap.exists()) {
        Swal.fire({ icon: "error", title: "Login Failed", text: "Incorrect username or password. Please check your details." });
        return;
      }
      let user = Object.values(snap.val())[0];
      try {
        await firebase.auth().signInWithEmailAndPassword(user.email, password);
      } catch (error) {
        Swal.fire({ icon: "error", title: "Login Failed", text: "Incorrect username or password. Please check your details." });
        return;
      }
      Swal.fire({ icon: "success", title: "Logged In!", showConfirmButton: false, timer: 1000 });
      bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      // Dashboard refresh handled by onAuthStateChanged
    };

    // Show dashboard after login
    async function showDashboard(userObj, uid) {
      currentUserUID = uid;
      showNavLoggedIn(userObj);
      document.getElementById('homeSection').style.display = "none";
      document.getElementById('dashboard').style.display = "";

      // Show profile info
      document.getElementById('profileName').textContent = userObj.fullName;
      document.getElementById('profileAvatar').src = userObj.avatar || "https://i.pravatar.cc/100?u="+userObj.username;
      document.getElementById('profileUsername').innerHTML = "@" + userObj.username;
      document.getElementById('profileRoleBADGE').textContent = userObj.role === "cash" ? "Cash User" : "Credit Card Holder";

      if (userObj.role === "cash") {
        // Cash user dashboard: search and contact
        document.getElementById('profileCardDetails').innerHTML = "";
        document.getElementById('dashboardContent').innerHTML = `
          <div class="card shadow mb-3">
            <div class="card-body">
              <h5 class="card-title">Find Credit Card Holders</h5>
              <form id="searchCardForm" class="mb-3">
                <input type="text" class="form-control mb-2" id="searchBank" placeholder="Bank Name">
                <input type="number" min="1" class="form-control mb-2" id="searchAmount" placeholder="Amount Needed">
                <button class="btn btn-primary w-100" type="submit">Search</button>
              </form>
              <div id="searchResults"></div>
            </div>
          </div>`;
        document.getElementById('searchCardForm').onsubmit = async function(ev) {
          ev.preventDefault();
          let bank = searchBank.value.trim().toLowerCase();
          let amount = Number(searchAmount.value);
          let snap = await firebase.database().ref("users").orderByChild("role").equalTo("card").once("value");
          let html = "";
          Object.entries(snap.val() || {}).forEach(([uid, u]) => {
            if ((!bank || (u.cardPostings || []).some(p => p.bank.toLowerCase().includes(bank))) &&
                (!amount || (u.cardPostings || []).some(p => Number(p.amount) >= amount))) {
              // Collect matching cards and display
              u.cardPostings.forEach((card, index) => {
                if ((!bank || card.bank.toLowerCase().includes(bank)) &&
                    (!amount || Number(card.amount) >= amount)) {
                  html += `<div class="credit-card-info">
                    <b>${u.username}</b> (Bank: ${card.bank})<br>
                    Card Amount: ₹${card.amount}
                    <button class='btn btn-success btn-sm float-end' onclick="contactAdmin('${u.username}')">Contact Admin</button>
                  </div>`;
                }
              });
            }
          });
          document.getElementById("searchResults").innerHTML = html || "<div>No matching credit card users found.</div>";
        };
      }
      else if(userObj.role === "card") {
        // Credit card holder dashboard: show posted cards with edit/delete + add form
        document.getElementById('profileCardDetails').innerHTML = "";
        document.getElementById('dashboardContent').innerHTML = `
          <div class="card shadow mb-3">
            <div class="card-body">
              <h5 class="card-title">Manage Your Credit Card Postings</h5>
              <div id="postedCards"></div>
              <hr/>
              <h6>Add New Card Posting</h6>
              <form id="newCardForm">
                <div class="mb-2"><input type="text" class="form-control" id="newCardBank" placeholder="Bank Name" required></div>
                <div class="mb-2"><input type="number" class="form-control" id="newCardAmount" placeholder="Limit Amount" required min="1"></div>
                <button class="btn btn-primary w-100" type="submit">Add Card</button>
              </form>
            </div>
          </div>
        `;

        const postedCardsDiv = document.getElementById('postedCards');

        function renderCards(cards) {
          if(!cards || cards.length === 0) {
            postedCardsDiv.innerHTML = "<p>No credit card postings yet.</p>";
            return;
          }
          postedCardsDiv.innerHTML = '';
          cards.forEach((card, idx) => {
            let cardHtml = document.createElement('div');
            cardHtml.className = 'credit-card-info position-relative';
            cardHtml.innerHTML = `
              <div><b>Bank:</b> ${card.bank}</div>
              <div><b>Limit:</b> ₹${card.amount}</div>
              <div class="actions position-absolute top-0 end-0 me-2 mt-2">
                <button class="btn btn-sm btn-outline-primary me-1" title="Edit" onclick="editCard(${idx})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteCard(${idx})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            `;
            postedCardsDiv.appendChild(cardHtml);
          });
        }

        // Local copy of card postings for current user:
        let cardPostings = userObj.cardPostings || [];

        renderCards(cardPostings);

        // Add new card posting
        document.getElementById('newCardForm').onsubmit = async function(e) {
          e.preventDefault();
          let bank = newCardBank.value.trim();
          let amount = newCardAmount.value.trim();
          if(!bank || !amount) {
            Swal.fire("Please fill all fields.");
            return;
          }
          cardPostings.push({ bank, amount });
          await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
          renderCards(cardPostings);
          newCardBank.value = "";
          newCardAmount.value = "";
          Swal.fire({ icon: "success", title: "Card added!" });
        };

        // Edit card
        window.editCard = async function(idx) {
          let card = cardPostings[idx];
          const { value: formValues } = await Swal.fire({
            title: 'Edit Credit Card Posting',
            html:
              `<input id="swalBank" class="swal2-input" placeholder="Bank Name" value="${card.bank}">` +
              `<input id="swalAmount" class="swal2-input" placeholder="Limit Amount" type="number" min="1" value="${card.amount}">`,
            focusConfirm: false,
            preConfirm: () => {
              return {
                bank: document.getElementById('swalBank').value.trim(),
                amount: document.getElementById('swalAmount').value.trim()
              }
            }
          });
          if (!formValues || !formValues.bank || !formValues.amount) {
            Swal.fire({ icon: "error", title: "Invalid Input", text: "Bank and Amount must be valid." });
            return;
          }
          cardPostings[idx] = formValues;
          await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
          renderCards(cardPostings);
          Swal.fire({ icon: "success", title: "Card updated!" });
        };

        // Delete card
        window.deleteCard = async function(idx) {
          const result = await Swal.fire({
            title: 'Are you sure?',
            text: "This card posting will be deleted.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete'
          });
          if (result.isConfirmed) {
            cardPostings.splice(idx,1);
            await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
            renderCards(cardPostings);
            Swal.fire({ icon: 'success', title: 'Deleted!' });
          }
        };
      }
    }

    // Contact Admin - sends username instead of UID now
    window.contactAdmin = function(username) {
      let url = `https://wa.me/918969467256?text=Request%20to%20connect%20with%20Credit%20Card%20Holder%20username:%20${encodeURIComponent(username)}`;
      window.open(url, "_blank");
    };

    // Logout
    function logout() {
      firebase.auth().signOut();
    }

    // Auth state change event
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        let snap = await firebase.database().ref("users/" + user.uid).once("value");
        if (snap.exists()) {
          showDashboard(snap.val(), user.uid);
        }
      } else {
        showNavLoggedOut();
        document.getElementById('dashboard').style.display = "none";
        document.getElementById('homeSection').style.display = "";
      }
    });
  </script>
</body>
</html>
