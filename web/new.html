<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cash ↔ Credit Card Platform</title>
  <!-- Google Fonts: Jost -->
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Bootstrap 5.3.3, Bootstrap Icons, SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      background: #f3f8ff;
      font-family: 'Jost', sans-serif;
      color: #2c3e50;
      scroll-behavior: smooth;
    }
    .navbar {
      background: linear-gradient(90deg, #2a2d72 0%, #4356ff 100%);
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
      z-index: 1030;
    }
    .navbar .navbar-brand, 
    .navbar .nav-link, 
    .navbar .navbar-text, 
    .navbar .dropdown-toggle {
      color: #f0f4ff !important;
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    .navbar .dropdown-menu {
      right:0; left:auto;
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 8px 20px rgb(0 0 0 / 0.15);
    }
    .bg-header {
      background: linear-gradient(90deg, #2a2d72 0%, #4356ff 100%);
      color: #f3f8ff;
      font-weight: 600;
      letter-spacing: 0.07em;
    }
    /* Homepage styles */
    #homeSection {
      padding: 5rem 1.5rem 4rem;
      max-width: 960px;
      margin: auto;
      margin-top: 50px;
    }
    #homeSection h1.display-4 {
      font-weight: 700;
      color: #2a2d72;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
      text-align: center;
    }
    #homeSection p.lead {
      font-size: 1.3rem;
      color: #4356ff;
      margin-bottom: 3rem;
      text-align: center;
    }
    /* Content boxes */
    .info-box {
      background: white;
      padding: 2rem 3rem;
      margin-bottom: 2rem;
      border-radius: 1rem;
      box-shadow: 0 6px 15px rgb(67 86 255 / 0.15);
      transition: box-shadow 0.3s ease;
    }
    .info-box:hover {
      box-shadow: 0 8px 30px rgb(67 86 255 / 0.3);
    }
    .info-box h3 {
      font-weight: 700;
      color: #2a2d72;
      margin-bottom: 1rem;
    }
    .info-box p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #2c3e50;
    }
    /* Buttons */
    button.btn-primary, button.btn-outline-primary {
      font-weight: 700;
      letter-spacing: 0.05em;
      border-radius: 30px;
      padding: 0.6rem 1.8rem;
      min-width: 140px;
      transition: background-color 0.3s ease;
    }
    button.btn-primary {
      background: #4356ff;
      border: none;
    }
    button.btn-primary:hover {
      background: #2a2d72;
    }
    button.btn-outline-primary {
      border-color: #4356ff;
      color: #4356ff;
    }
    button.btn-outline-primary:hover {
      background: #4356ff;
      color: #f3f8ff;
    }
    /* Dashboard styling */
    .dashboard-section {
      min-height: 70vh;
      padding: 3rem 1rem 3rem;
      max-width: 960px;
      margin: auto;
    }
    .profile-card {
      max-width: 420px;
      border-radius: 1rem;
      margin: auto;
      margin-top: 50px;
      box-shadow: 0 4px 25px rgb(67 86 255 / 0.25);
      background: #ffffff;
      transition: box-shadow 0.3s ease;
    }
    .profile-card:hover {
      box-shadow: 0 6px 35px rgb(67 86 255 / 0.45);
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #2a2d72;
      background: #fff;
      transition: transform 0.3s ease;
    }
    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px #4356ff76;
    }
    .credit-card-info {
      border-radius: 12px;
      background: #e1eaff;
      margin: 10px 0;
      padding: 12px 16px;
      font-weight: 600;
      box-shadow: 0 2px 10px rgb(67 86 255 / 0.1);
      position: relative;
      transition: background 0.3s;
    }
    .credit-card-info:hover {
      background: #c7d5ff;
      cursor: default;
    }
    .credit-card-info .actions {
      float: right;
    }
    .credit-card-info .actions button {
      margin-left: 8px;
    }
    .badge-primary-custom {
      background-color: #4356ff;
      font-weight: 600;
      letter-spacing: 0.05em;
      font-size: 0.85rem;
      padding: 0.45em 0.85em;
      border-radius: 20px;
    }
    /* Responsive */
    @media (max-width:700px) { 
      .profile-card { max-width: 95vw;}
      #homeSection {
        padding: 3rem 1rem 3rem;
      }
      .info-box {
        padding: 1.5rem 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">Cash ↔ Credit Card</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navBarContent" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navBarContent">
        <ul class="navbar-nav ms-auto align-items-center" id="navLoggedOut" style="display:flex;">
          <li class="nav-item">
            <button class="btn btn-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
          </li>
        </ul>
        <!-- Logged In Nav -->
        <ul class="navbar-nav ms-auto align-items-center" id="navLoggedIn" style="display:none;">
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle d-flex align-items-center" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="https://i.pravatar.cc/70?u=cardholder" id="navAvatar" class="rounded-circle me-1" width="32" height="32" alt="User avatar"/><span id="navUsername"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li class="dropdown-item-text"><b id="navRole"></b></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item text-danger" onclick="logout()">Logout</button></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Main Container -->
  <main>
    <section id="homeSection" aria-label="Homepage introduction and website details">
      <h1 class="display-4">Welcome to Cash ↔ Credit Card Platform</h1>
      <p class="lead">Turn your cash into credit or help others while earning — a safe, instant, and easy solution.</p>

      <div class="info-box" tabindex="0" aria-label="What is this platform about">
        <h3>What is this website?</h3>
        <p>
          This platform connects users who need cash by providing credit card access from verified credit card holders willing to share their cards securely. It bridges an important gap between cash needs and credit card availability.
        </p>
      </div>

      <div class="info-box" tabindex="0" aria-label="Problems this platform solves">
        <h3>Problems We Solve</h3>
        <p>
          Many individuals face challenges accessing quick cash or credit card limits. Traditional loans involve complex processes and delays. Our platform offers an immediate solution by connecting cash users with credit card holders directly, reducing dependency on banks and formal credit systems.
        </p>
      </div>

      <div class="info-box" tabindex="0" aria-label="Why choose this platform">
        <h3>Why Choose Us?</h3>
        <ul style="font-size:1.1rem; color:#2c3e50;">
          <li><strong>Secure & Verified:</strong> User accounts are authenticated and managed securely with Firebase.</li>
          <li><strong>Easy-to-Use:</strong> Intuitive interface to post, search, and manage card details or cash requests.</li>
          <li><strong>Instant Communication:</strong> Connects you instantly via WhatsApp for easy communication with admins.</li>
          <li><strong>Earn & Save Time:</strong> Credit card holders can earn by sharing their limits; cash users get funds faster.</li>
          <li><strong>Transparency:</strong> Clear card limits, user profiles, and roles ensure trustworthiness.</li>
        </ul>
      </div>

      <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg me-3" data-bs-toggle="modal" data-bs-target="#loginModal" aria-label="Login to your account">Login</button>
        <button class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal" aria-label="Register for a new account">Register</button>
      </div>

      <p class="text-center text-muted mt-5" style="font-size: 0.9rem;">
        &copy; 2025 Cash ↔ Credit Card Platform. All rights reserved.
      </p>
    </section>

    <!-- Dashboard container (hidden initially) -->
    <section class="dashboard-section" id="dashboard" role="region" aria-label="User dashboard" style="display:none;">
      <div class="row gx-4 gy-4">
        <!-- Profile Section -->
        <div class="col-md-4">
          <div class="card shadow profile-card" role="region" aria-labelledby="profileName">
            <div class="card-body text-center">
              <img id="profileAvatar" src="https://i.pravatar.cc/100?u=404" class="profile-avatar mb-3" alt="Profile Avatar" />
              <div class="h4 mb-0 fw-bold" id="profileName" tabindex="0"></div>
              <div class="text-muted mb-1" id="profileUsername" tabindex="0"></div>
              <hr/>
              <span class="badge badge-primary-custom" id="profileRoleBADGE" aria-label="User role badge"></span>
              <div id="profileCardDetails" class="mt-4"></div>
            </div>
          </div>
        </div>
        <!-- Dashboard Actions -->
        <div class="col-md-8" id="dashboardContent" role="main" tabindex="0" style="margin-top: 75px;"></div>
      </div>
    </section>
  </main>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true" aria-labelledby="registerModalLabel" role="dialog">
    <div class="modal-dialog">
      <form class="modal-content" id="registerForm" autocomplete="off" aria-describedby="registerFormHelp">
        <div class="modal-header bg-header">
          <h5 class="modal-title text-white" id="registerModalLabel">Create Your Account</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="regFullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" required id="regFullName" aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="regUsername" class="form-label">Choose Username</label>
            <input type="text" class="form-control" required id="regUsername" aria-required="true" pattern="^[A-Za-z0-9_]+$" />
            <div class="form-text" id="registerFormHelp">Use letters, numbers, underscores only. Must be unique.</div>
          </div>
          <div class="mb-3">
            <label for="regEmail" class="form-label">Email Address</label>
            <input type="email" class="form-control" required id="regEmail" aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="regPassword" class="form-label">Create Password</label>
            <input type="password" class="form-control" required id="regPassword" aria-required="true" minlength="6" />
          </div>
          <div class="mb-3">
            <label class="form-label">Register As</label>
            <select class="form-select" required id="regRole" aria-required="true" aria-label="Select user role">
              <option value="" disabled selected>Select Role</option>
              <option value="cash">Cash User</option>
              <option value="card">Credit Card Holder</option>
            </select>
          </div>
        </div>
        <div class="modal-footer p-3">
          <button type="submit" class="btn btn-primary w-100 fw-bold">Register Now</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" aria-labelledby="loginModalLabel" role="dialog">
    <div class="modal-dialog">
      <form class="modal-content" id="loginForm" autocomplete="off">
        <div class="modal-header bg-header">
          <h5 class="modal-title text-white" id="loginModalLabel">Welcome Back</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="loginUsername" class="form-label">Username</label>
            <input type="text" class="form-control" required id="loginUsername" aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" required id="loginPassword" aria-required="true" />
          </div>
        </div>
        <div class="modal-footer p-3">
          <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase Initialization -->
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCxJqJadOqmVA9XHUEnf_bzY8_j9WhoOsc",
      authDomain: "chat-ebbc6.firebaseapp.com",
      databaseURL: "https://chat-ebbc6-default-rtdb.firebaseio.com",
      projectId: "chat-ebbc6",
      storageBucket: "chat-ebbc6.appspot.com",
      messagingSenderId: "900704224803",
      appId: "1:900704224803:web:849180c787132c7baa1396",
      measurementId: "G-YYNMD5MS6M"
    };
    firebase.initializeApp(firebaseConfig);
    let currentUserUID = null;
    let lastSearchRequestedAmount = 0;

    // Navbar toggles
    function showNavLoggedIn(userObj) {
      document.getElementById('navLoggedOut').style.display = 'none';
      document.getElementById('navLoggedIn').style.display = '';
      document.getElementById('navUsername').textContent = userObj.username;
      document.getElementById('navAvatar').src = "https://i.pravatar.cc/70?u=" + encodeURIComponent(userObj.username);
      document.getElementById('navRole').textContent = userObj.role === "cash" ? "Cash User" : "Credit Card Holder";
    }
    function showNavLoggedOut() {
      document.getElementById('navLoggedOut').style.display = '';
      document.getElementById('navLoggedIn').style.display = 'none';
    }

    // Registration
    document.getElementById('registerForm').onsubmit = async function(e) {
      e.preventDefault();
      let fullName = regFullName.value.trim();
      let username_plain = regUsername.value.trim();
      let username = username_plain.toLowerCase();
      let email = regEmail.value.trim();
      let password = regPassword.value;
      let role = regRole.value;
      if(!(/^[A-Za-z0-9_]+$/.test(username_plain))) {
        Swal.fire("Username may only use letters, numbers, underscores");
        return;
      }
      let snap = await firebase.database().ref("users").orderByChild("username_lowercase").equalTo(username).once("value");
      if (snap.exists()) {
        Swal.fire({
          icon: "error",
          title: "Username Taken!",
          text: "Please choose another username (case-insensitive)."
        });
        return;
      }
      try {
        let cred = await firebase.auth().createUserWithEmailAndPassword(email, password);
        let userObj = {
          fullName, username: username_plain, username_lowercase: username,
          email, role, avatar: "https://i.pravatar.cc/100?u="+encodeURIComponent(username_plain),
          cardPostings: []
        };
        await firebase.database().ref("users/" + cred.user.uid).set(userObj);
        Swal.fire({
          icon: "success",
          title: "Registered!",
          text: "Your account has been created successfully. Please login to continue."
        });
        bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
      } catch (error) {
        Swal.fire({ icon: "error", title: "Registration Failed", text: error.message });
      }
    };

    // Login
    document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      let username = loginUsername.value.trim().toLowerCase();
      let password = loginPassword.value;
      let snap = await firebase.database().ref("users").orderByChild("username_lowercase").equalTo(username).once("value");
      if (!snap.exists()) {
        Swal.fire({ icon: "error", title: "Login Failed", text: "Incorrect username or password." });
        return;
      }
      let user = Object.values(snap.val())[0];
      try {
        await firebase.auth().signInWithEmailAndPassword(user.email, password);
      } catch (error) {
        Swal.fire({ icon: "error", title: "Login Failed", text: "Incorrect username or password." });
        return;
      }
      Swal.fire({ icon: "success", title: "Logged In!", showConfirmButton: false, timer: 1000 });
      bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
    };

    // Show dashboard logic
    async function showDashboard(userObj, uid) {
      currentUserUID = uid;
      showNavLoggedIn(userObj);

      // Hide homepage, show dashboard only
      document.getElementById('homeSection').style.display = 'none';
      document.getElementById('dashboard').style.display = '';

      // Profile info
      document.getElementById('profileName').textContent = userObj.fullName;
      document.getElementById('profileAvatar').src = userObj.avatar || "https://i.pravatar.cc/100?u="+encodeURIComponent(userObj.username);
      document.getElementById('profileUsername').textContent = "@" + userObj.username;
      document.getElementById('profileRoleBADGE').textContent = userObj.role === "cash" ? "Cash User" : "Credit Card Holder";
      document.getElementById('profileCardDetails').innerHTML = "";

      if (userObj.role === "cash") {
        // Cash user dashboard
        document.getElementById('dashboardContent').innerHTML = `
          <div class="card shadow mb-3">
            <div class="card-body">
              <h5 class="card-title fw-bold mb-3">Find Credit Card Holders</h5>
              <form id="searchCardForm" class="mb-3" aria-label="Search credit card holders form">
                <input type="text" class="form-control mb-2" id="searchBank" placeholder="Bank Name (optional)" aria-label="Bank name input"/>
                <input type="number" min="1" class="form-control mb-2" id="searchAmount" placeholder="Amount Needed (optional)" aria-label="Amount needed input"/>
                <button class="btn btn-primary w-100 fw-bold" type="submit" aria-label="Search button">Search</button>
              </form>
              <div id="searchResults" tabindex="0" aria-live="polite" aria-atomic="true"></div>
            </div>
          </div>`;
          
        document.getElementById('searchCardForm').onsubmit = async function(ev) {
          ev.preventDefault();
          let bank = searchBank.value.trim().toLowerCase();
          let amount = Number(searchAmount.value) || 0;
          lastSearchRequestedAmount = amount;

          let snap = await firebase.database().ref("users").orderByChild("role").equalTo("card").once("value");
          let html = "";
          Object.entries(snap.val() || {}).forEach(([cardUid, u]) => {
            if ((!bank || (u.cardPostings || []).some(p => p.bank.toLowerCase().includes(bank))) &&
                (!amount || (u.cardPostings || []).some(p => Number(p.amount) >= amount))) {
              u.cardPostings.forEach((card, index) => {
                if ((!bank || card.bank.toLowerCase().includes(bank)) &&
                    (!amount || Number(card.amount) >= amount)) {
                  html += `<div class="credit-card-info" role="region" aria-label="Credit card info of ${u.username} bank ${card.bank}">
                    <b>${u.username}</b> (Bank: ${card.bank})<br/>
                    Card Limit: ₹${card.amount.toLocaleString()}<br/>
                    <button class="btn btn-sm btn-success mt-2" onclick="contactAdmin('${u.username}', '${card.bank}', ${card.amount}, ${amount})" aria-label="Contact admin about card at ${card.bank} from ${u.username}">
                      Contact Admin
                    </button>
                  </div>`;
                }
              });
            }
          });
          document.getElementById("searchResults").innerHTML = html || "<p class='text-muted'>No matching credit card holders found.</p>";
        };

      } else if(userObj.role === "card") {
        // Credit card holder dashboard
        document.getElementById('dashboardContent').innerHTML = `
          <div class="card shadow">
            <div class="card-body">
              <h5 class="card-title fw-bold mb-3">Manage Your Credit Card Postings</h5>
              <div id="postedCards" role="list" aria-label="Your credit card postings"></div>
              <hr />
              <h6 class="fw-semibold mb-3">Add New Card Posting</h6>
              <form id="newCardForm" aria-label="Add new credit card form">
                <div class="mb-3">
                  <input type="text" class="form-control" id="newCardBank" placeholder="Bank Name" required aria-required="true" />
                </div>
                <div class="mb-3">
                  <input type="number" class="form-control" id="newCardAmount" placeholder="Limit Amount (₹)" required min="1" aria-required="true" />
                </div>
                <button class="btn btn-primary w-100 fw-bold" type="submit">Add Card</button>
              </form>
            </div>
          </div>
        `;
        const postedCardsDiv = document.getElementById('postedCards');

        function renderCards(cards) {
          if(!cards || cards.length === 0) {
            postedCardsDiv.innerHTML = "<p class='text-muted'>You have no credit card postings yet.</p>";
            return;
          }
          postedCardsDiv.innerHTML = '';
          cards.forEach((card, idx) => {
            let cardHtml = document.createElement('div');
            cardHtml.className = 'credit-card-info mb-2 position-relative';
            cardHtml.setAttribute('role', 'listitem');
            cardHtml.setAttribute('aria-label', `Card from bank ${card.bank} with limit ₹${card.amount.toLocaleString()}`);
            cardHtml.innerHTML = `
              <div><b>Bank:</b> ${card.bank}</div>
              <div><b>Limit:</b> ₹${Number(card.amount).toLocaleString()}</div>
              <div class="actions position-absolute top-0 end-0 me-3 mt-3">
                <button class="btn btn-sm btn-outline-primary me-1" title="Edit Card" aria-label="Edit card button bank ${card.bank}" onclick="editCard(${idx})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Card" aria-label="Delete card button bank ${card.bank}" onclick="deleteCard(${idx})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            `;
            postedCardsDiv.appendChild(cardHtml);
          });
        }

        let cardPostings = userObj.cardPostings || [];
        renderCards(cardPostings);

        document.getElementById('newCardForm').onsubmit = async function(e) {
          e.preventDefault();
          let bank = newCardBank.value.trim();
          let amount = newCardAmount.value.trim();
          if(!bank || !amount) {
            Swal.fire({icon:"warning", title:"Missing fields", text:"Please fill all fields."});
            return;
          }
          if(isNaN(amount) || Number(amount) < 1){
            Swal.fire({icon:"error", title:"Invalid amount", text:"Limit amount must be a positive number."});
            return;
          }
          cardPostings.push({ bank, amount: Number(amount) });
          await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
          renderCards(cardPostings);
          newCardBank.value = "";
          newCardAmount.value = "";
          Swal.fire({ icon: "success", title: "Card added!", timer: 1200, showConfirmButton: false });
        };

        window.editCard = async function(idx) {
          let card = cardPostings[idx];
          const { value: formValues } = await Swal.fire({
            title: 'Edit Credit Card Posting',
            html:
              `<input id="swalBank" class="swal2-input" placeholder="Bank Name" value="${card.bank}">` +
              `<input id="swalAmount" class="swal2-input" placeholder="Limit Amount" type="number" min="1" value="${card.amount}">`,
            focusConfirm: false,
            preConfirm: () => {
              return {
                bank: document.getElementById('swalBank').value.trim(),
                amount: document.getElementById('swalAmount').value.trim()
              }
            }
          });
          if (!formValues || !formValues.bank || !formValues.amount || Number(formValues.amount) < 1) {
            Swal.fire({ icon: "error", title: "Invalid Input", text: "Both Bank and a valid positive Amount are required." });
            return;
          }
          cardPostings[idx] = { bank: formValues.bank, amount: Number(formValues.amount) };
          await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
          renderCards(cardPostings);
          Swal.fire({ icon: "success", title: "Card updated!", timer: 1000, showConfirmButton: false });
        };

        window.deleteCard = async function(idx) {
          const result = await Swal.fire({
            title: 'Confirm Delete',
            text: "Are you sure you want to delete this card posting?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
          });
          if (result.isConfirmed) {
            cardPostings.splice(idx, 1);
            await firebase.database().ref("users/" + currentUserUID).update({ cardPostings });
            renderCards(cardPostings);
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1000, showConfirmButton: false });
          }
        };
      }
    }

    // Contact Admin alert then WhatsApp
    window.contactAdmin = function(username, bank, cardLimit, neededAmount) {
      Swal.fire({
        title: 'Contact Admin',
        icon: 'info',
        html:
          `<p><b>User:</b> ${username}</p>` +
          `<p><b>Card Bank:</b> ${bank}</p>` +
          `<p><b>Card Limit:</b> ₹${cardLimit.toLocaleString()}</p>` +
          `<p><b>Your Needed Amount:</b> ₹${(neededAmount || lastSearchRequestedAmount).toLocaleString()}</p>` +
          `<p>Proceed to connect via WhatsApp with the admin to facilitate your request.</p>`,
        showCancelButton: true,
        confirmButtonText: 'Contact Admin',
        focusConfirm: false,
      }).then(result => {
        if (result.isConfirmed) {
          let url = `https://wa.me/918969467256?text=` +
            encodeURIComponent(
              `Request to connect with Credit Card Holder username: ${username}, Bank: ${bank}, Card Limit: ₹${cardLimit}, Needed Amount: ₹${neededAmount || lastSearchRequestedAmount}`
            );
          window.open(url, "_blank");
        }
      });
    };

    function logout() {
      firebase.auth().signOut();
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        let snap = await firebase.database().ref("users/" + user.uid).once("value");
        if (snap.exists()) {
          showDashboard(snap.val(), user.uid);
        }
      } else {
        showNavLoggedOut();
        document.getElementById('dashboard').style.display = "none";
        document.getElementById('homeSection').style.display = "";
      }
    });
  </script>
</body>
</html>
