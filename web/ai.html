<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Chat</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Jost", sans-serif;
        }
        
        :root {
            --text-color: #e3e3e3;
            --subheading-color: #828282;
            --placeholder-color: #a6a6a6;
            --primary-color: #242424;
            --secondary-color: #383838;
            --secondary-hover-color: #444;
            --sidebar-color: #1e1e1e;
            --accent-color: #4285f4;
            --accent-gradient: linear-gradient(to right, #4285f4, #d96570);
            --border-color: #444;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #f44336;
        }
        
        .light_mode {
            --text-color: #222;
            --subheading-color: #a0a0a0;
            --placeholder-color: #6c6c6c;
            --primary-color: #fff;
            --secondary-color: #e9eef6;
            --secondary-hover-color: #dbe1ea;
            --sidebar-color: #f5f7fa;
            --border-color: #ddd;
        }
        
        body {
            background: var(--primary-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar-header {
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }
        
        .sidebar-header h2 {
            color: var(--text-color);
            font-size: 1.3rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.4rem;
            border-radius: 50%;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        
        .toggle-sidebar:hover {
            background: var(--secondary-color);
        }
        
        .new-chat-btn {
            margin: 1rem;
            padding: 0.75rem 1rem;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: transform 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
        }
        
        .new-chat-btn span {
            font-size: 1.2rem;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .history-date {
            color: var(--subheading-color);
            font-size: 0.8rem;
            font-weight: 500;
            margin: 1rem 0 0.5rem;
            padding: 0 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .history-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s ease;
            color: var(--text-color);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            font-size: 0.9rem;
            position: relative;
        }
        
        .history-item:hover {
            background: var(--secondary-color);
        }
        
        .history-item.active {
            background: var(--accent-color);
            color: white;
        }
        
        .history-item .icon {
            flex-shrink: 0;
            font-size: 1.1rem;
        }
        
        .history-item .title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .delete-session {
            display: none;
            margin-left: auto;
            font-size: 1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .history-item:hover .delete-session {
            display: block;
        }
        
        .delete-session:hover {
            opacity: 1;
        }
        
        .sidebar.collapsed .history-item .title,
        .sidebar.collapsed .history-date,
        .sidebar.collapsed .new-chat-btn span:last-child,
        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }
        
        .sidebar.collapsed .new-chat-btn {
            justify-content: center;
            padding: 0.75rem;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 2rem 2rem 0;
            transition: all 0.3s ease;
        }
        
        .header.hidden {
            display: none;
        }
        
        .header .title {
            width: fit-content;
            font-size: 2.5rem;
            background-clip: text;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            font-size: 1.5rem;
            color: var(--subheading-color);
            font-weight: 400;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-list {
            padding: 1rem 2rem;
            flex: 1;
            overflow-y: auto;
            scrollbar-color: #999 transparent;
        }
        
        .chat-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-list::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 3px;
        }
        
        .chat-list .message {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-list .message .message-content {
            display: flex;
            gap: 1rem;
            width: 100%;
            align-items: flex-start;
        }
        
        .chat-list .message .text {
            color: var(--text-color);
            white-space: pre-wrap;
            line-height: 1.5;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            background: var(--secondary-color);
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        
        .chat-list .message.outgoing .text {
            background: var(--accent-gradient);
            color: white;
            margin-left: auto;
        }
        
        .chat-list .message.error .text {
            color: var(--error-color);
            background: rgba(244, 67, 54, 0.1);
        }
        
        .chat-list .message.warning .text {
            color: var(--warning-color);
            background: rgba(255, 152, 0, 0.1);
        }
        
        .chat-list .message.loading .text {
            display: none;
        }
        
        .chat-list .message .avatar {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 50%;
            align-self: flex-start;
            flex-shrink: 0;
        }
        
        .chat-list .message.loading .avatar {
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }
        
        .chat-list .message .actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
            align-self: flex-start;
            flex-shrink: 0;
        }
        
        .chat-list .message .icon {
            color: var(--text-color);
            cursor: pointer;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            font-size: 1.1rem;
            visibility: hidden;
            transition: background 0.2s ease;
        }
        
        .chat-list .message .icon.hide {
            visibility: hidden;
        }
        
        .chat-list .message:not(.loading, .error):hover .icon:not(.hide) {
            visibility: visible;
        }
        
        .chat-list .message .icon:hover {
            background: var(--secondary-hover-color);
        }
        
        .chat-list .message .loading-indicator {
            display: none;
            gap: 0.6rem;
            width: 100%;
            flex-direction: column;
        }
        
        .chat-list .message.loading .loading-indicator {
            display: flex;
        }
        
        .chat-list .message .loading-indicator .loading-bar {
            height: 8px;
            width: 100%;
            border-radius: 0.135rem;
            background-position: -800px 0;
            background: linear-gradient(to right, #4285f4, var(--primary-color), #4285f4);
            animation: loading 3s linear infinite;
        }
        
        .chat-list .message .loading-indicator .loading-bar:last-child {
            width: 70%;
        }
        
        @keyframes loading {
            0% {
                background-position: -800px 0;
            }
            100% {
                background-position: 800px 0;
            }
        }
        
        /* Code Block Styles */
        .code-block {
            position: relative;
            margin: 0.75rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #2d2d2d;
            color: #ccc;
            font-size: 0.8rem;
        }
        
        .code-language {
            font-weight: 500;
        }
        
        .copy-code-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s ease;
        }
        
        .copy-code-btn:hover {
            background: #3d3d3d;
        }
        
        .code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .code-block code {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        /* Typing Area */
        .typing-area {
            padding: 1rem 2rem;
            background: var(--primary-color);
            transition: padding 0.3s ease;
            border-top: 1px solid var(--border-color);
        }
        
        .typing-area :where(.typing-form, .action-buttons) {
            display: flex;
            gap: 0.75rem;
        }
        
        .typing-form .input-wrapper {
            width: 100%;
            min-height: 50px;
            display: flex;
            position: relative;
            align-items: center;
        }
        
        .typing-form .typing-input {
            height: 100%;
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9rem;
            color: var(--text-color);
            padding: 0.9rem 3.5rem 0.9rem 1.25rem;
            border-radius: 100px;
            background: var(--secondary-color);
            transition: background 0.2s ease;
            max-height: 120px;
            overflow-y: auto;
            font-family: "Jost", sans-serif;
        }
        
        .typing-form .typing-input:focus {
            background: var(--secondary-hover-color);
        }
        
        .typing-form .typing-input::placeholder {
            color: var(--placeholder-color);
        }
        
        .typing-area .icon {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            font-size: 1.2rem;
            color: var(--text-color);
            align-items: center;
            justify-content: center;
            background: var(--secondary-color);
            transition: 0.2s ease;
            border: none;
            outline: none;
        }
        
        .typing-area .icon:hover {
            background: var(--secondary-hover-color);
        }
        
        .typing-area .icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-area .icon:disabled:hover {
            background: var(--secondary-color);
        }
        
        .typing-form #send-message-button {
            position: absolute;
            right: 0;
            outline: none;
            border: none;
            transform: scale(0);
            background: transparent;
            transition: transform 0.2s ease;
        }
        
        .typing-form .typing-input:valid ~ #send-message-button {
            transform: scale(1);
        }
        
        .typing-area .disclaimer-text {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 1rem;
            color: var(--placeholder-color);
        }
        
        /* API Key Modal */
        #apiKeySection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        #apiKeyModal {
            background: var(--primary-color);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            width: 90%;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        #apiKeyModal h4 {
            margin-bottom: 0.5rem;
            font-size: 1.4rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }
        
        #apiKeyModal p {
            color: var(--subheading-color);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        #apiKeyInput {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--secondary-color);
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s ease;
            font-family: "Jost", sans-serif;
        }
        
        #apiKeyInput:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        
        #apiKeyModal button {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: transform 0.2s ease;
            width: 100%;
            font-family: "Jost", sans-serif;
        }
        
        #apiKeyModal button:hover {
            transform: translateY(-2px);
        }
        
        #apiKeyModal a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        #apiKeyModal a:hover {
            text-decoration: underline;
        }
        
        .api-key-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .api-key-actions button {
            flex: 1;
        }
        
        .api-key-actions button.secondary {
            background: var(--secondary-color);
            color: var(--text-color);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--subheading-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .empty-state .material-symbols-rounded {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 1rem;
        }
        
        /* AI Status Indicator */
        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--secondary-color);
            border-radius: 1rem;
            margin: 0 2rem 1rem;
            font-size: 0.85rem;
            color: var(--text-color);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }
        
        .status-indicator.warning {
            background: var(--warning-color);
        }
        
        .status-indicator.error {
            background: var(--error-color);
        }
        
        /* Mobile styles */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 101;
            background: var(--secondary-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 220px;
            }
            
            .header {
                padding: 1.5rem 1.5rem 0;
            }
            
            .chat-list {
                padding: 1rem 1.5rem;
            }
            
            .typing-area {
                padding: 1rem 1.5rem;
            }
        }
        
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(-100%);
                z-index: 100;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .overlay.active {
                display: block;
            }
            
            .sidebar.collapsed {
                width: 220px;
            }
            
            .header {
                padding: 1.5rem 1rem 0;
            }
            
            .header .title {
                font-size: 2rem;
            }
            
            .header .subtitle {
                font-size: 1.3rem;
            }
            
            .chat-list {
                padding: 1rem;
            }
            
            .typing-area {
                padding: 1rem;
            }
            
            .ai-status {
                margin: 0 1rem 1rem;
            }
            
            .mobile-menu-btn {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .header .title {
                font-size: 1.8rem;
            }
            
            .header .subtitle {
                font-size: 1.2rem;
            }
            
            .chat-list .message .text {
                max-width: 85%;
                font-size: 0.85rem;
            }
            
            .typing-area :where(.typing-form, .action-buttons) {
                gap: 0.5rem;
            }
            
            .typing-form .input-wrapper {
                height: 46px;
            }
            
            .typing-form .typing-input {
                padding: 0.9rem 3rem 0.9rem 1rem;
            }
            
            .typing-area .icon {
                height: 46px;
                width: 46px;
                font-size: 1.1rem;
            }
            
            .typing-area .disclaimer-text {
                font-size: 0.75rem;
                margin-top: 0.75rem;
            }
            
            #apiKeyModal {
                padding: 1.5rem;
                margin: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .header {
                padding: 1rem 1rem 0;
            }
            
            .header .title {
                font-size: 1.6rem;
            }
            
            .header .subtitle {
                font-size: 1.1rem;
            }
            
            .chat-list {
                padding: 0.75rem 0.5rem;
            }
            
            .chat-list .message .text {
                max-width: 80%;
                padding: 0.6rem 0.8rem;
            }
            
            .chat-list .message .avatar {
                width: 32px;
                height: 32px;
            }
            
            .typing-area {
                padding: 0.75rem;
            }
            
            .typing-form .typing-input {
                font-size: 0.85rem;
                padding: 0.8rem 2.8rem 0.8rem 0.9rem;
            }
            
            .typing-area .icon {
                height: 42px;
                width: 42px;
                font-size: 1rem;
            }
            
            .empty-state {
                padding: 2rem 1rem;
            }
            
            .empty-state .material-symbols-rounded {
                font-size: 3rem;
            }
            
            .ai-status {
                margin: 0 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 400px) {
            .header .title {
                font-size: 1.4rem;
            }
            
            .header .subtitle {
                font-size: 1rem;
            }
            
            .chat-list .message .text {
                max-width: 75%;
            }
            
            .typing-area .action-buttons {
                flex-direction: column;
            }
            
            .typing-area .icon {
                height: 38px;
                width: 38px;
            }
        }
        
        /* Portrait mode on mobile */
        @media (max-height: 700px) and (orientation: portrait) {
            .header {
                padding: 1rem 1rem 0;
            }
            
            .header .title {
                font-size: 1.6rem;
                margin-bottom: 0.25rem;
            }
            
            .header .subtitle {
                font-size: 1.1rem;
            }
            
            .chat-list {
                padding: 0.5rem 1rem;
            }
            
            .typing-area {
                padding: 0.75rem 1rem;
            }
        }
        
        /* Landscape mode on mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                display: none;
            }
            
            .chat-list {
                padding: 0.5rem 1rem;
            }
            
            .typing-area {
                padding: 0.5rem 1rem;
            }
            
            .typing-form .input-wrapper {
                min-height: 40px;
            }
            
            .typing-area .icon {
                height: 40px;
                width: 40px;
            }
        }
        
        /* Retry and error handling */
        .retry-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .retry-button:hover {
            opacity: 0.9;
        }
        
        .fallback-notice {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="light_mode">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn material-symbols-rounded">menu</button>
    
    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chat History</h2>
            <button class="toggle-sidebar material-symbols-rounded" title="Collapse sidebar">chevron_left</button>
        </div>
        
        <button class="new-chat-btn">
            <span class="material-symbols-rounded">add</span>
            <span>New Chat</span>
        </button>
        
        <div class="chat-history" id="chatHistory">
            <!-- Chat history will be populated here -->
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Greetings -->
        <header class="header">
            <h1 class="title">Hello, there</h1>
            <p class="subtitle">How can I help you today?</p>
        </header>
        <br>
        <!-- AI Status Indicator -->
        <div class="ai-status" id="aiStatus">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Connected to Gemini AI</span>
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-list" id="chatList">
                <div class="empty-state">
                    <span class="material-symbols-rounded">chat</span>
                    <p>No messages yet. Start a conversation by typing a message!</p>
                </div>
            </div>
            
            <!-- Typing Area -->
            <div class="typing-area">
              <form action="#" class="typing-form">
                <div class="input-wrapper">
                  <textarea placeholder="Enter a prompt here" class="typing-input" id="userInput" maxlength="2000" required disabled rows="1"></textarea>
                  <button type="submit" id="send-message-button" class="icon material-symbols-rounded" disabled>send</button>
                </div>
                <div class="action-buttons">
                  <span id="theme-toggle-button" class="icon material-symbols-rounded" title="Toggle theme">dark_mode</span>
                  <span id="api-key-button" class="icon material-symbols-rounded" title="API Key settings">key</span>
                </div>
              </form>
              <p class="disclaimer-text">
                Gemini may display inaccurate info, including about people, so double-check its responses.
              </p>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeySection" style="display: none;">
        <div id="apiKeyModal">
            <h4>Get started with Gemini</h4>
            <p>Enter your API key to begin chatting with Gemini AI.</p>
            <input type="password" id="apiKeyInput" placeholder="Your Gemini API key..." />
            <small style="color: var(--subheading-color); display: block; margin-bottom: 1.5rem;">Get one at <a href="https://makersuite.google.com/app/apikey" target="_blank">makersuite.google.com</a></small>
            <button onclick="setApiKey()">Continue</button>
            <div class="api-key-actions">
                <button class="secondary" onclick="clearApiKey()">Clear Key</button>
                <button onclick="closeApiKeyModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Highlight.js
        hljs.highlightAll();
        
        // DOM elements
        const typingForm = document.querySelector(".typing-form");
        const chatContainer = document.querySelector(".chat-list");
        const toggleThemeButton = document.querySelector("#theme-toggle-button");
        const apiKeyButton = document.querySelector("#api-key-button");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("send-message-button");
        const sidebar = document.querySelector(".sidebar");
        const toggleSidebarBtn = document.querySelector(".toggle-sidebar");
        const newChatBtn = document.querySelector(".new-chat-btn");
        const chatHistory = document.getElementById("chatHistory");
        const header = document.querySelector(".header");
        const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const aiStatus = document.getElementById("aiStatus");
        const statusIndicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");
        
        // State variables
        let userMessage = null;
        let isResponseGenerating = false;
        let messages = []; // Current chat messages
        let chatSessions = {}; // All chat sessions organized by date
        let currentChatId = null; // ID of the current chat session
        let currentAI = 'gemini'; // Current AI service being used
        let geminiFailedAttempts = 0; // Count of consecutive Gemini failures
        
        // API configuration
        const getApiKey = () => localStorage.getItem('geminiApiKey');
        const GEMINI_API_URL = () => `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${getApiKey()}`;
        
        // Free AI service endpoints (mock for demonstration)
        const FREE_AI_SERVICES = {
            openAssistant: {
                name: "OpenAssistant",
                url: "https://api.open-assistant.io/chat",
                // This is a mock implementation since we don't have a real free API
            },
            huggingFace: {
                name: "Hugging Face",
                url: "https://api-inference.huggingface.co/models/",
                // This is a mock implementation
            }
        };
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        // Update AI status indicator
        function updateAIStatus(status, message) {
            statusIndicator.className = 'status-indicator';
            if (status === 'connected') {
                statusIndicator.classList.add('success');
                statusText.textContent = message || `Connected to ${currentAI === 'gemini' ? 'Gemini AI' : FREE_AI_SERVICES[currentAI].name}`;
            } else if (status === 'warning') {
                statusIndicator.classList.add('warning');
                statusText.textContent = message;
            } else if (status === 'error') {
                statusIndicator.classList.add('error');
                statusText.textContent = message;
            }
        }
        
        // Switch to a free AI service
        function switchToFreeAI(reason) {
            if (currentAI === 'gemini') {
                // Try to switch to a free AI
                const freeAIs = Object.keys(FREE_AI_SERVICES);
                if (freeAIs.length > 0) {
                    currentAI = freeAIs[0];
                    updateAIStatus('warning', `Switched to ${FREE_AI_SERVICES[currentAI].name} (${reason})`);
                    
                    // Show notification to user
                    const notice = document.createElement('div');
                    notice.className = 'fallback-notice';
                    notice.innerHTML = `<span class="material-symbols-rounded">warning</span> 
                                       Gemini AI is unavailable. Using ${FREE_AI_SERVICES[currentAI].name} instead.`;
                    chatContainer.appendChild(notice);
                    
                    setTimeout(() => {
                        notice.style.opacity = '0';
                        setTimeout(() => notice.remove(), 300);
                    }, 5000);
                    
                    return true;
                }
            }
            return false;
        }
        
        // Generate a unique ID for chat sessions
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Format date for display
        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }
        
        // Extract and format code blocks in the message
        function formatCodeBlocks(text) {
            const codeBlockRegex = /```(\w+)?\s*([\s\S]*?)```/g;
            
            let formattedText = text;
            let match;
            let codeBlocks = [];
            let index = 0;
            
            while ((match = codeBlockRegex.exec(text)) !== null) {
                const language = match[1] || 'text';
                const code = match[2].trim();
                
                const blockId = `code-block-${index++}`;
                
                formattedText = formattedText.replace(
                    match[0], 
                    `<div class="code-block" id="${blockId}"></div>`
                );
                
                codeBlocks.push({
                    id: blockId,
                    language: language,
                    code: code
                });
            }
            
            return { formattedText, codeBlocks };
        }
        
        // Render code blocks with syntax highlighting
        function renderCodeBlocks(codeBlocks) {
            codeBlocks.forEach(block => {
                const codeBlockElement = document.getElementById(block.id);
                if (codeBlockElement) {
                    const language = block.language.toLowerCase();
                    const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                    
                    codeBlockElement.innerHTML = `
                        <div class="code-header">
                            <span class="code-language">${block.language || 'Text'}</span>
                            <button class="copy-code-btn" onclick="copyCode('${block.id}')">
                                <span class="material-symbols-rounded" style="font-size: 16px;">content_copy</span>
                                Copy
                            </button>
                        </div>
                        <pre><code class="language-${validLanguage}">${hljs.highlight(block.code, { language: validLanguage }).value}</code></pre>
                    `;
                }
            });
            
            hljs.highlightAll();
        }
        
        // Copy code to clipboard
        function copyCode(blockId) {
            const codeBlock = document.getElementById(blockId);
            if (codeBlock) {
                const codeElement = codeBlock.querySelector('code');
                if (codeElement) {
                    navigator.clipboard.writeText(codeElement.textContent)
                        .then(() => {
                            const copyBtn = codeBlock.querySelector('.copy-code-btn');
                            if (copyBtn) {
                                const originalHTML = copyBtn.innerHTML;
                                copyBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size: 16px;">check</span> Copied!';
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalHTML;
                                }, 2000);
                            }
                        })
                        .catch(err => {
                            console.error('Failed to copy code: ', err);
                        });
                }
            }
        }
        
        // Load chat sessions from localStorage
        function loadChatSessions() {
            const savedSessions = localStorage.getItem("chatSessions");
            if (savedSessions) {
                chatSessions = JSON.parse(savedSessions);
                renderChatHistory();
            } else {
                chatSessions = {};
            }
        }
        
        // Save chat sessions to localStorage
        function saveChatSessions() {
            localStorage.setItem("chatSessions", JSON.stringify(chatSessions));
        }
        
        // Render chat history in the sidebar
        function renderChatHistory() {
            chatHistory.innerHTML = '';
            
            if (Object.keys(chatSessions).length === 0) {
                chatHistory.innerHTML = '<div class="empty-state" style="padding: 1rem; font-size: 0.9rem;"><p>No chat history yet</p></div>';
                return;
            }
            
            const dates = {};
            Object.values(chatSessions).forEach(chat => {
                const date = new Date(chat.timestamp);
                const dateKey = date.toDateString();
                
                if (!dates[dateKey]) {
                    dates[dateKey] = [];
                }
                
                dates[dateKey].push(chat);
            });
            
            const sortedDates = Object.keys(dates).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const dateHeader = document.createElement('div');
                dateHeader.className = 'history-date';
                dateHeader.textContent = formatDate(date);
                chatHistory.appendChild(dateHeader);
                
                dates[dateKey].sort((a, b) => b.timestamp - a.timestamp);
                
                dates[dateKey].forEach(chat => {
                    const chatItem = document.createElement('a');
                    chatItem.className = 'history-item';
                    if (chat.id === currentChatId) {
                        chatItem.classList.add('active');
                    }
                    
                    chatItem.innerHTML = `
                        <span class="icon material-symbols-rounded">chat</span>
                        <span class="title">${chat.title || 'New Chat'}</span>
                        <span class="material-symbols-rounded delete-session">delete</span>
                    `;
                    
                    chatItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-session')) {
                            e.preventDefault();
                            e.stopPropagation();
                            deleteChatSession(chat.id);
                            return;
                        }
                        loadChat(chat.id);
                    });
                    
                    chatHistory.appendChild(chatItem);
                });
            });
        }
        
        // Delete a specific chat session
        function deleteChatSession(chatId) {
            Swal.fire({
                title: 'Delete this chat?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                confirmButtonColor: '#d33',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    delete chatSessions[chatId];
                    
                    if (currentChatId === chatId) {
                        const remainingChats = Object.keys(chatSessions);
                        if (remainingChats.length > 0) {
                            const mostRecentChat = Object.values(chatSessions).reduce((latest, chat) => {
                                return chat.timestamp > latest.timestamp ? chat : latest;
                            });
                            loadChat(mostRecentChat.id);
                        } else {
                            createNewChat();
                        }
                    }
                    
                    saveChatSessions();
                    renderChatHistory();
                    Swal.fire('Deleted!', 'Chat session has been deleted.', 'success');
                }
            });
        }
        
        // Create a new chat session
        function createNewChat() {
            currentChatId = generateChatId();
            messages = [];
            
            chatSessions[currentChatId] = {
                id: currentChatId,
                title: 'New Chat',
                timestamp: Date.now(),
                messages: []
            };
            
            saveChatSessions();
            renderChatHistory();
            
            chatContainer.innerHTML = '<div class="empty-state"><span class="material-symbols-rounded">chat</span><p>No messages yet. Start a conversation by typing a message!</p></div>';
            header.classList.remove('hidden');
        }
        
        // Load a specific chat session
        function loadChat(chatId) {
            if (chatSessions[chatId]) {
                currentChatId = chatId;
                messages = [...chatSessions[chatId].messages];
                
                renderChatHistory();
                
                chatContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    chatContainer.innerHTML = '<div class="empty-state"><span class="material-symbols-rounded">chat</span><p>No messages yet. Start a conversation by typing a message!</p></div>';
                    header.classList.remove('hidden');
                } else {
                    messages.forEach((msg, index) => {
                        const type = msg.role === 'user' ? 'outgoing' : 'incoming';
                        const avatarSrc = type === 'outgoing' ? 'https://i.postimg.cc/L8hd043C/images.png' : 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Google-gemini-icon.svg/2048px-Google-gemini-icon.svg.png';
                        
                        const { formattedText, codeBlocks } = formatCodeBlocks(msg.content);
                        
                        const html = `<div class="message-content">
                                        <img class="avatar" src="${avatarSrc}" alt="${type === 'outgoing' ? 'User' : 'Gemini'} avatar">
                                        <div class="text">${formattedText.replace(/\n/g, '<br>')}</div>
                                    </div>
                                    <div class="actions">
                                        ${type === 'incoming' && index === messages.length - 1 ? 
                                            `<span onClick="regenerateResponse()" class="icon material-symbols-rounded" title="Regenerate response">refresh</span>` : ''}
                                        <span onClick="copyMessage(this)" class="icon material-symbols-rounded" title="Copy message">content_copy</span>
                                    </div>`;
                        const div = createMessageElement(html, type);
                        chatContainer.appendChild(div);
                        
                        if (codeBlocks.length > 0) {
                            setTimeout(() => {
                                renderCodeBlocks(codeBlocks);
                            }, 0);
                        }
                    });
                    
                    header.classList.add('hidden');
                }
                
                chatContainer.scrollTo(0, chatContainer.scrollHeight);
                
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                }
            }
        }
        
        // Regenerate the last AI response
        function regenerateResponse() {
            if (isResponseGenerating || messages.length < 2) return;
            
            let lastUserMessageIndex = -1;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'user') {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastUserMessageIndex === -1) return;
            
            messages = messages.slice(0, lastUserMessageIndex + 1);
            
            chatSessions[currentChatId].messages = messages;
            saveChatSessions();
            
            loadChat(currentChatId);
            
            userMessage = messages[messages.length - 1].content;
            isResponseGenerating = true;
            
            setTimeout(showLoadingAnimation, 500);
        }
        
        // Load theme and initialize the app
        const initializeApp = () => {
            const isLightMode = (localStorage.getItem("themeColor") === "light_mode");
            
            document.body.classList.toggle("light_mode", isLightMode);
            toggleThemeButton.innerText = isLightMode ? "dark_mode" : "light_mode";
            toggleThemeButton.setAttribute('title', isLightMode ? 'Switch to dark mode' : 'Switch to light mode');
            
            loadChatSessions();
            
            const chatIds = Object.keys(chatSessions);
            if (chatIds.length > 0) {
                const mostRecentChat = Object.values(chatSessions).reduce((latest, chat) => {
                    return chat.timestamp > latest.timestamp ? chat : latest;
                });
                
                loadChat(mostRecentChat.id);
            } else {
                createNewChat();
            }
            
            updateAIStatus('connected');
        }
        
        // Create a new message element and return it
        const createMessageElement = (content, ...classes) => {
            const div = document.createElement("div");
            div.classList.add("message", ...classes);
            div.innerHTML = content;
            return div;
        }
        
        // Show typing effect by displaying words one by one
        const showTypingEffect = (text, textElement, incomingMessageDiv) => {
            const words = text.split(' ');
            let currentWordIndex = 0;
            const typingInterval = setInterval(() => {
                textElement.innerHTML += (currentWordIndex === 0 ? '' : ' ') + words[currentWordIndex++];
                incomingMessageDiv.querySelector(".icon").classList.add("hide");
                
                if (currentWordIndex === words.length) {
                    clearInterval(typingInterval);
                    isResponseGenerating = false;
                    incomingMessageDiv.querySelector(".icon").classList.remove("hide");
                    
                    messages.push({ role: 'model', content: text });
                    chatSessions[currentChatId].messages = messages;
                    
                    if (messages.length === 2) {
                        const firstMessage = messages[0].content;
                        chatSessions[currentChatId].title = firstMessage.length > 30 
                            ? firstMessage.substring(0, 30) + '...' 
                            : firstMessage;
                    }
                    
                    saveChatSessions();
                    renderChatHistory();
                    
                    const { formattedText, codeBlocks } = formatCodeBlocks(text);
                    textElement.innerHTML = formattedText.replace(/\n/g, '<br>');
                    
                    if (codeBlocks.length > 0) {
                        setTimeout(() => {
                            renderCodeBlocks(codeBlocks);
                        }, 0);
                    }
                    
                    // Reset Gemini failure count on successful response
                    if (currentAI === 'gemini') {
                        geminiFailedAttempts = 0;
                    }
                }
                
                chatContainer.scrollTo(0, chatContainer.scrollHeight);
            }, 50);
        }
        
        // Mock free AI response (in a real app, this would call an actual API)
        const generateFreeAIResponse = async (prompt) => {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
            
            // Simple mock responses based on prompt content
            if (prompt.toLowerCase().includes('hello') || prompt.toLowerCase().includes('hi')) {
                return "Hello! I'm an AI assistant. How can I help you today?";
            } else if (prompt.toLowerCase().includes('weather')) {
                return "I don't have real-time weather data, but I can help you find weather information if you tell me your location.";
            } else if (prompt.toLowerCase().includes('code') || prompt.toLowerCase().includes('program')) {
                return "Here's a simple example of code:\n\n```python\nprint('Hello, World!')\n```\n\nThis is a basic Python program that prints a message.";
            } else if (prompt.toLowerCase().includes('joke')) {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "Why did the scarecrow win an award? Because he was outstanding in his field!",
                    "Why don't eggs tell jokes? They'd crack each other up!"
                ];
                return jokes[Math.floor(Math.random() * jokes.length)];
            } else {
                return `I understand you're asking about "${prompt}". As a free AI assistant, I have limited capabilities compared to premium services like Gemini, but I'll do my best to help. Could you provide more details about what you're looking for?`;
            }
        };
        
        // Fetch response from the API with retry logic and fallback
        const generateAPIResponse = async (incomingMessageDiv, retryCount = 0) => {
            const textElement = incomingMessageDiv.querySelector(".text");
            try {
                if (currentAI === 'gemini') {
                    if (!getApiKey()) throw new Error('API key not set. Please enter it.');
                    
                    const contents = messages.map(msg => ({ role: msg.role, parts: [{ text: msg.content }] }));
                    contents.push({ role: "user", parts: [{ text: userMessage }] });
                    
                    const response = await fetch(GEMINI_API_URL(), {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents }),
                    });
                    
                    const data = await response.json();
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            geminiFailedAttempts++;
                            if (geminiFailedAttempts >= 2 && switchToFreeAI('server issues')) {
                                // Switch to free AI and retry
                                return generateAPIResponse(incomingMessageDiv, 0);
                            }
                            throw new Error('server_overload');
                        }
                        throw new Error(data.error?.message || 'API request failed');
                    }
                    
                    const apiResponse = data.candidates[0].content.parts[0].text;
                    showTypingEffect(apiResponse, textElement, incomingMessageDiv);
                } else {
                    // Use free AI service
                    const response = await generateFreeAIResponse(userMessage);
                    showTypingEffect(response, textElement, incomingMessageDiv);
                }
            } catch (error) {
                if (error.message === 'server_overload' && retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    setTimeout(() => {
                        generateAPIResponse(incomingMessageDiv, retryCount + 1);
                    }, delay);
                    return;
                }
                
                isResponseGenerating = false;
                
                if (error.message === 'server_overload') {
                    textElement.innerHTML = `Server is currently overloaded. Please try again in a moment. 
                       <button class="retry-button" onclick="retryLastMessage()">
                         <span class="material-symbols-rounded" style="font-size: 16px;">refresh</span>
                         Retry
                       </button>`;
                    textElement.parentElement.closest(".message").classList.add("error");
                    updateAIStatus('error', 'Gemini AI is overloaded');
                } else {
                    textElement.innerHTML = error.message;
                    textElement.parentElement.closest(".message").classList.add("error");
                    
                    if (error.message.includes('API key') && switchToFreeAI('invalid API key')) {
                        updateAIStatus('warning', `Using ${FREE_AI_SERVICES[currentAI].name} (invalid Gemini key)`);
                        // Retry with free AI
                        isResponseGenerating = true;
                        setTimeout(() => generateAPIResponse(incomingMessageDiv, 0), 500);
                        return;
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'API Error',
                            text: error.message,
                            confirmButtonText: 'OK'
                        });
                    }
                }
            } finally {
                if (error && error.message !== 'server_overload') {
                    incomingMessageDiv.classList.remove("loading");
                }
            }
        }
        
        // Retry the last message
        function retryLastMessage() {
            if (messages.length === 0) return;
            
            const lastUserMessage = messages.filter(msg => msg.role === 'user').pop();
            if (!lastUserMessage) return;
            
            userMessage = lastUserMessage.content;
            isResponseGenerating = true;
            
            const errorMessage = chatContainer.querySelector('.message.error');
            if (errorMessage) {
                errorMessage.remove();
            }
            
            setTimeout(showLoadingAnimation, 500);
        }
        
        // Show a loading animation while waiting for the API response
        const showLoadingAnimation = () => {
            const aiName = currentAI === 'gemini' ? 'Gemini' : FREE_AI_SERVICES[currentAI].name;
            const html = `<div class="message-content">
                            <img class="avatar" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Google-gemini-icon.svg/2048px-Google-gemini-icon.svg.png" alt="${aiName} avatar">
                            <p class="text"></p>
                            <div class="loading-indicator">
                                <div class="loading-bar"></div>
                                <div class="loading-bar"></div>
                                <div class="loading-bar"></div>
                            </div>
                        </div>
                        <div class="actions">
                            <span class="icon material-symbols-rounded hide">content_copy</span>
                        </div>`;
            const incomingMessageDiv = createMessageElement(html, "incoming", "loading");
            chatContainer.appendChild(incomingMessageDiv);
            chatContainer.scrollTo(0, chatContainer.scrollHeight);
            generateAPIResponse(incomingMessageDiv);
        }
        
        // Copy message text to the clipboard
        const copyMessage = (copyButton) => {
            const messageText = copyButton.parentElement.parentElement.querySelector(".text").innerText;
            navigator.clipboard.writeText(messageText);
            const originalIcon = copyButton.innerText;
            copyButton.innerText = "done";
            copyButton.setAttribute('title', 'Copied!');
            setTimeout(() => {
                copyButton.innerText = originalIcon;
                copyButton.setAttribute('title', 'Copy message');
            }, 2000);
        }
        
        // Handle sending outgoing chat messages
        const handleOutgoingChat = () => {
            userMessage = userInput.value.trim();
            if(!userMessage || isResponseGenerating) return;
            
            isResponseGenerating = true;
            messages.push({ role: 'user', content: userMessage });
            
            if (chatContainer.querySelector('.empty-state')) {
                chatContainer.innerHTML = '';
            }
            
            if (messages.length === 1) {
                header.classList.add('hidden');
            }
            
            const html = `<div class="message-content">
                            <img class="avatar" src="https://i.postimg.cc/L8hd043C/images.png" alt="User avatar">
                            <p class="text">${userMessage.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="actions">
                            <span onClick="copyMessage(this)" class="icon material-symbols-rounded" title="Copy message">content_copy</span>
                        </div>`;
            const outgoingMessageDiv = createMessageElement(html, "outgoing");
            chatContainer.appendChild(outgoingMessageDiv);
            
            userInput.value = '';
            autoResize(userInput);
            chatContainer.scrollTo(0, chatContainer.scrollHeight);
            
            setTimeout(showLoadingAnimation, 500);
        }
        
        // Toggle between light and dark themes
        toggleThemeButton.addEventListener("click", () => {
            const isLightMode = document.body.classList.toggle("light_mode");
            localStorage.setItem("themeColor", isLightMode ? "light_mode" : "dark_mode");
            toggleThemeButton.innerText = isLightMode ? "dark_mode" : "light_mode";
            toggleThemeButton.setAttribute('title', isLightMode ? 'Switch to dark mode' : 'Switch to light mode');
        });
        
        // Prevent default form submission and handle outgoing chat
        typingForm.addEventListener("submit", (e) => {
            e.preventDefault(); 
            handleOutgoingChat();
        });
        
        // API Key Handling
        function showApiKeyModal() {
            document.getElementById('apiKeySection').style.display = 'flex';
            document.getElementById('apiKeyInput').value = getApiKey() || '';
            document.getElementById('apiKeyInput').focus();
        }
        
        function closeApiKeyModal() {
            document.getElementById('apiKeySection').style.display = 'none';
        }
        
        function setApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                Swal.fire('Error!', 'Please enter a valid API key.', 'error');
                return;
            }
            localStorage.setItem('geminiApiKey', key);
            closeApiKeyModal();
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            
            // Reset to Gemini AI when a new key is set
            currentAI = 'gemini';
            geminiFailedAttempts = 0;
            updateAIStatus('connected', 'Connected to Gemini AI');
            
            Swal.fire('Success!', 'Ready to chat with Gemini!', 'success');
        }
        
        function clearApiKey() {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('apiKeyInput').value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            Swal.fire('Cleared!', 'API key has been removed.', 'info');
        }
        
        // Toggle sidebar collapse/expand
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            toggleSidebarBtn.textContent = sidebar.classList.contains('collapsed') 
                ? 'chevron_right' 
                : 'chevron_left';
            toggleSidebarBtn.setAttribute('title', sidebar.classList.contains('collapsed') 
                ? 'Expand sidebar' 
                : 'Collapse sidebar');
        });
        
        // Create new chat when new chat button is clicked
        newChatBtn.addEventListener('click', createNewChat);
        
        // Toggle mobile sidebar
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });
        
        // On Load
        window.onload = () => {
            const apiKey = getApiKey();
            if (!apiKey) {
                showApiKeyModal();
            } else {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
            
            initializeApp();
            
            // Auto-resize textarea on input
            userInput.addEventListener('input', function() {
                autoResize(this);
            });
        };
        
        // Enter to send (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleOutgoingChat();
            }
        });
        
        // API key button event
        apiKeyButton.addEventListener('click', showApiKeyModal);
        
        // Close modal when clicking outside
        document.getElementById('apiKeySection').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApiKeyModal();
            }
        });
    </script>
</body>
</html>
